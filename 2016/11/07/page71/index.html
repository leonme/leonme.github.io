<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>结合WebSocket编写WebGL综合场景示例 | Zerone Blog</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="HTML5,WebGL,WebSocket," />
  

  <meta name="description" content="#结合WebSocket编写WebGL综合场景示例在WebGL场景中导入多个Babylon骨骼模型，在局域网用WebSocket实现多用户交互控制。首先是场景截图：上图在场景中导入一个Babylon骨骼模型，使用asdw、空格、鼠标控制加速度移动，在移动时播放骨骼动画。上图在场景中加入更多的骨骼模型（兔子），兔子感知到人类接近后会加速远离人类。上图，一个局域网中的新玩家进入场景，（他们头上的数字是">
<meta property="og:type" content="article">
<meta property="og:title" content="结合WebSocket编写WebGL综合场景示例">
<meta property="og:url" content="http://www.leonma.cn/2016/11/07/page71/index.html">
<meta property="og:site_name" content="Zerone Blog">
<meta property="og:description" content="#结合WebSocket编写WebGL综合场景示例在WebGL场景中导入多个Babylon骨骼模型，在局域网用WebSocket实现多用户交互控制。首先是场景截图：上图在场景中导入一个Babylon骨骼模型，使用asdw、空格、鼠标控制加速度移动，在移动时播放骨骼动画。上图在场景中加入更多的骨骼模型（兔子），兔子感知到人类接近后会加速远离人类。上图，一个局域网中的新玩家进入场景，（他们头上的数字是">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/657116/201611/657116-20161104092432330-1844981251.png">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/657116/201611/657116-20161104092921783-1111568630.png">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/657116/201611/657116-20161104093417315-1396209353.png">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/657116/201611/657116-20161104094056596-1505476394.png">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/657116/201611/657116-20161104094910408-100628683.png">
<meta property="og:image" content="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif">
<meta property="og:image" content="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif">
<meta property="og:updated_time" content="2016-11-09T16:37:57.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="结合WebSocket编写WebGL综合场景示例">
<meta name="twitter:description" content="#结合WebSocket编写WebGL综合场景示例在WebGL场景中导入多个Babylon骨骼模型，在局域网用WebSocket实现多用户交互控制。首先是场景截图：上图在场景中导入一个Babylon骨骼模型，使用asdw、空格、鼠标控制加速度移动，在移动时播放骨骼动画。上图在场景中加入更多的骨骼模型（兔子），兔子感知到人类接近后会加速远离人类。上图，一个局域网中的新玩家进入场景，（他们头上的数字是">
<meta name="twitter:image" content="http://images2015.cnblogs.com/blog/657116/201611/657116-20161104092432330-1844981251.png">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=028c63b1" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/category/"
            rel="noopener noreferrer"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            rel="noopener noreferrer"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/atom.xml"
            rel="noopener noreferrer"
            target="_blank"
            >
            RSS
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            rel="noopener noreferrer"
            target="_self"
            >
            搜索
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、工程结构："><span class="toc-text">一、工程结构：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、基本场景构建和骨骼模型导入："><span class="toc-text">二、基本场景构建和骨骼模型导入：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、在createScene-方法的开头部分建立了一个基本的PlayGround场景："><span class="toc-text">1、在createScene()方法的开头部分建立了一个基本的PlayGround场景：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、接下来是在场景中导入第一个人物的骨骼模型："><span class="toc-text">2、接下来是在场景中导入第一个人物的骨骼模型：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、加速度运动控制"><span class="toc-text">三、加速度运动控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、初速度投影"><span class="toc-text">1、初速度投影</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、计算水平加速度，与水平位移"><span class="toc-text">2、计算水平加速度，与水平位移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、计算垂直加速度、垂直位移："><span class="toc-text">3、计算垂直加速度、垂直位移：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、应用位移："><span class="toc-text">4、应用位移：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、数据发送："><span class="toc-text">四、数据发送：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、Java后台的Websocket代码："><span class="toc-text">1、Java后台的Websocket代码：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、前台的WebSocket代码位于WebSocket-js中："><span class="toc-text">2、前台的WebSocket代码位于WebSocket.js中：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、建立一些“NPC物体”，也要对他们的状态进行同步"><span class="toc-text">3、建立一些“NPC物体”，也要对他们的状态进行同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、客户端对服务器端传来的信息进行处理："><span class="toc-text">4、客户端对服务器端传来的信息进行处理：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a、添加新玩家，代码位于WebSocket-js184行："><span class="toc-text">a、添加新玩家，代码位于WebSocket.js184行：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b、多个客户端之间同步玩家的状态："><span class="toc-text">b、多个客户端之间同步玩家的状态：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#c、最后是对NPC物体运动同步的处理："><span class="toc-text">c、最后是对NPC物体运动同步的处理：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、部署和使用："><span class="toc-text">五、部署和使用：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六、写在后面的话："><span class="toc-text">六、写在后面的话：</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-page71" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">结合WebSocket编写WebGL综合场景示例</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2016.11.07</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>Leon Ma</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/HTML5/">HTML5</a>
  </span>



      

    </div>
  </header>

  <div class="article-content">
    
      <p>#结合WebSocket编写WebGL综合场景示例<br>在WebGL场景中导入多个Babylon骨骼模型，在局域网用WebSocket实现多用户交互控制。<br>首先是场景截图：<br><img src="http://images2015.cnblogs.com/blog/657116/201611/657116-20161104092432330-1844981251.png" alt="picture"><br>上图在场景中导入一个Babylon骨骼模型，使用asdw、空格、鼠标控制加速度移动，在移动时播放骨骼动画。<br><img src="http://images2015.cnblogs.com/blog/657116/201611/657116-20161104092921783-1111568630.png" alt="picture"><br>上图在场景中加入更多的骨骼模型（兔子），兔子感知到人类接近后会加速远离人类。<br><img src="http://images2015.cnblogs.com/blog/657116/201611/657116-20161104093417315-1396209353.png" alt="picture"><br>上图，一个局域网中的新玩家进入场景，（他们头上的数字是WebSocket分配的session id），兔子们受到0和1的叠加影响。<br>&nbsp;<br>具体实现：</p>
<h2 id="一、工程结构："><a href="#一、工程结构：" class="headerlink" title="一、工程结构："></a>一、工程结构：</h2><p>&nbsp;前台WebStorm工程：<br><img src="http://images2015.cnblogs.com/blog/657116/201611/657116-20161104094056596-1505476394.png" alt="picture"><br>其中map.jpg是地形高度图，tree.jpg不是树而是地面泥土的纹理。。。<br>LIB文件夹里是引用的第三方库（babylon.max.js是2.4版），MYLIB文件夹里是我自己编写或整理修改的库，PAGE里是专用于此网页的脚本文件<br>　　其中FileText.js是js前台文件处理库（这里只用到了其中的产生日期字符串函数）<br>　　MoveWeb.js是加速度计算库<br>　　Sdyq.js里是对物体对象的定义和操作监听<br>　　Player.js里是继承了物体对象的玩家对象和动物对象的定义<br>　　utils是一些其他工具<br>　　View是页面控制库<br>MODEL文件夹里是人物和兔子的骨骼模型文件。<br>后台MyEclipse工程：<br><img src="http://images2015.cnblogs.com/blog/657116/201611/657116-20161104094910408-100628683.png" alt="picture"><br>使用JDK1.7，因为Tomcat v8.0里包含了WebSocket所用的库，所以不需要引入额外jar包，只写了一个类。</p>
<h2 id="二、基本场景构建和骨骼模型导入："><a href="#二、基本场景构建和骨骼模型导入：" class="headerlink" title="二、基本场景构建和骨骼模型导入："></a>二、基本场景构建和骨骼模型导入：</h2><p>html页面文件：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>使用websocket联网进行数据传递，这个节点应该既可以做主机也可以加入他人的主机<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"all_base"</span> <span class="attr">style</span>=<span class="string">"position:fixed;top:0px;left: 0px;"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div_canvas"</span> <span class="attr">style</span>=<span class="string">"float: left;width: 75%;border: 1px solid"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"renderCanvas"</span> <span class="attr">style</span>=<span class="string">"width: 100%;height: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div_log"</span> <span class="attr">style</span>=<span class="string">"float: left;border: 1px solid;overflow-y: scroll"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div_bottom"</span> <span class="attr">style</span>=<span class="string">"float: left;width: 100%;height: 100px;padding-top: 10px;padding-left: 10px"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">style</span>=<span class="string">"width: 200px"</span> <span class="attr">id</span>=<span class="string">"str_ip"</span> <span class="attr">value</span>=<span class="string">"localhost"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"str_name"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn_create"</span> <span class="attr">onclick</span>=<span class="string">"createScene()"</span> <span class="attr">disabled</span>=<span class="string">true</span>&gt;</span>启动场景<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn_connect"</span> <span class="attr">onclick</span>=<span class="string">"Connect()"</span> &gt;</span>websocket连接<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn_close"</span> <span class="attr">onclick</span>=<span class="string">"Close()"</span> <span class="attr">disabled</span>=<span class="string">true</span>&gt;</span>关闭连接<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"str_id"</span> <span class="attr">style</span>=<span class="string">"display: inline-block"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">style</span>=<span class="string">"width: 400px"</span> <span class="attr">id</span>=<span class="string">"str_message"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn_send"</span> <span class="attr">onclick</span>=<span class="string">"Send()"</span>&gt;</span>发送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../JS/LIB/babylon.max.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../JS/MYLIB/View.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../JS/LIB/jquery-1.11.3.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../JS/MYLIB/FileText.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../JS/MYLIB/Sdyq.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../JS/MYLIB/player.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../JS/MYLIB/MoveWeb.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../JS/MYLIB/utils.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../JS/PAGE/scene_link.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../JS/PAGE/WebSocket.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">    <span class="keyword">var</span> username=<span class="string">""</span>;</div><div class="line">    <span class="built_in">window</span>.onload=BeforeLog;</div><div class="line">    <span class="built_in">window</span>.onresize=Resize_Pllsselect;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">BeforeLog</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        Resize_Pllsselect();</div><div class="line">        <span class="comment">//DrawYzm();</span></div><div class="line">        <span class="comment">//createScene();</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> str_log=<span class="built_in">document</span>.getElementById(<span class="string">"div_log"</span>);</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Resize_Pllsselect</span>(<span class="params"></span>)</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> size=window_size();</div><div class="line">        <span class="built_in">document</span>.getElementById(<span class="string">"all_base"</span>).style.height=(size.height+<span class="string">"px"</span>);</div><div class="line">        <span class="built_in">document</span>.getElementById(<span class="string">"all_base"</span>).style.width=(size.width+<span class="string">"px"</span>);</div><div class="line">        <span class="built_in">document</span>.getElementById(<span class="string">"div_canvas"</span>).style.height=(size.height<span class="number">-100</span>+<span class="string">"px"</span>);</div><div class="line">        str_log.style.height=(size.height<span class="number">-100</span>+<span class="string">"px"</span>);</div><div class="line">        str_log.style.width=((size.width/<span class="number">4</span>)<span class="number">-4</span>+<span class="string">"px"</span>);</div><div class="line">        <span class="keyword">if</span>(engine!=<span class="literal">undefined</span>)</div><div class="line">        &#123;</div><div class="line">            engine.resize();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> state=<span class="string">"offline"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> arr_myplayers=[];</div><div class="line">    <span class="keyword">var</span> arr_webplayers=[];</div><div class="line">    <span class="keyword">var</span> arr_animals=[];</div><div class="line">    <span class="keyword">var</span> arr_tempobj=[];<span class="comment">//暂存对象初始化信息</span></div><div class="line">    <span class="keyword">var</span> tempobj;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"renderCanvas"</span>);</div><div class="line">    <span class="keyword">var</span> ms0=<span class="number">0</span>;<span class="comment">//上一时刻毫秒数</span></div><div class="line">    <span class="keyword">var</span> mst=<span class="number">0</span>;<span class="comment">//下一时刻毫秒数</span></div><div class="line">    <span class="keyword">var</span> schange=<span class="number">0</span>;<span class="comment">//秒差</span></div><div class="line"></div><div class="line">    <span class="keyword">var</span> skybox,</div><div class="line">            scene,</div><div class="line">            sceneCharger = <span class="literal">false</span>,</div><div class="line">            meshOctree,</div><div class="line">            cameraArcRotative = [],<span class="comment">//弧形旋转相机列表</span></div><div class="line">            octree;</div><div class="line">    <span class="keyword">var</span> engine;</div><div class="line">    <span class="keyword">var</span> shadowGenerator ;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>View Code其中包含对页面尺寸大小变化的响应和一些全局变量的定义<br>scene_link.js文件中包含场景的构建和模型导入：</p>
<h3 id="1、在createScene-方法的开头部分建立了一个基本的PlayGround场景："><a href="#1、在createScene-方法的开头部分建立了一个基本的PlayGround场景：" class="headerlink" title="1、在createScene()方法的开头部分建立了一个基本的PlayGround场景："></a>1、在createScene()方法的开头部分建立了一个基本的PlayGround场景：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">engine = <span class="keyword">new</span> BABYLON.Engine(canvas, <span class="literal">true</span>);</div><div class="line">    engine.displayLoadingUI();</div><div class="line">    scene = <span class="keyword">new</span> BABYLON.Scene(engine);</div><div class="line"></div><div class="line">    <span class="comment">//在场景中启用碰撞检测</span></div><div class="line">    scene.collisionsEnabled = <span class="literal">true</span>;</div><div class="line">    <span class="comment">//scene.workerCollisions = true;//启动webworker进程处理碰撞，确实可以有效使用多核运算，加大帧数！！</span></div><div class="line">    <span class="comment">//但是worker是异步运算的，其数据传输策略会导致movewithcollition执行顺序与期望的顺序不符</span></div><div class="line"></div><div class="line">    <span class="comment">//定向光照</span></div><div class="line">    <span class="keyword">var</span> LightDirectional = <span class="keyword">new</span> BABYLON.DirectionalLight(<span class="string">"dir01"</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">-2</span>, <span class="number">-4</span>, <span class="number">2</span>), scene);</div><div class="line">    LightDirectional.diffuse = <span class="keyword">new</span> BABYLON.Color3(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);<span class="comment">//散射颜色</span></div><div class="line">    LightDirectional.specular = <span class="keyword">new</span> BABYLON.Color3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);<span class="comment">//镜面反射颜色</span></div><div class="line">    LightDirectional.position = <span class="keyword">new</span> BABYLON.Vector3(<span class="number">250</span>, <span class="number">400</span>, <span class="number">0</span>);</div><div class="line">    LightDirectional.intensity = <span class="number">1.8</span>;<span class="comment">//强度</span></div><div class="line">    shadowGenerator = <span class="keyword">new</span> BABYLON.ShadowGenerator(<span class="number">1024</span>, LightDirectional);<span class="comment">//为该光源建立阴影生成器，用在submesh上时一直在报错，不知道为了什么</span></div><div class="line"></div><div class="line">    <span class="comment">//弧形旋转相机</span></div><div class="line">    cameraArcRotative[<span class="number">0</span>] = <span class="keyword">new</span> BABYLON.ArcRotateCamera(<span class="string">"CameraBaseRotate"</span>, -<span class="built_in">Math</span>.PI/<span class="number">2</span>, <span class="built_in">Math</span>.PI/<span class="number">2.2</span>, <span class="number">12</span>, <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">5.0</span>, <span class="number">0</span>), scene);</div><div class="line">    cameraArcRotative[<span class="number">0</span>].wheelPrecision = <span class="number">15</span>;<span class="comment">//鼠标滚轮？</span></div><div class="line">    cameraArcRotative[<span class="number">0</span>].lowerRadiusLimit = <span class="number">2</span>;</div><div class="line">    cameraArcRotative[<span class="number">0</span>].upperRadiusLimit = <span class="number">22</span>;</div><div class="line">    cameraArcRotative[<span class="number">0</span>].minZ = <span class="number">0</span>;</div><div class="line">    cameraArcRotative[<span class="number">0</span>].minX = <span class="number">4096</span>;</div><div class="line">    scene.activeCamera = cameraArcRotative[<span class="number">0</span>];</div><div class="line">    cameraArcRotative[<span class="number">0</span>].attachControl(canvas);<span class="comment">//控制关联</span></div><div class="line"></div><div class="line">    <span class="comment">//地面</span></div><div class="line">    <span class="comment">//name,url,width,height,subdivisions,minheight,maxheight,updateble,onready,scene</span></div><div class="line">    ground = BABYLON.Mesh.CreateGroundFromHeightMap(<span class="string">"ground"</span>, <span class="string">"../IMAGE/map.jpg"</span>, <span class="number">1000</span>, <span class="number">1000</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">60</span>, scene, <span class="literal">true</span>);<span class="comment">//地面类型的网格</span></div><div class="line">    <span class="keyword">var</span> groundMaterial = <span class="keyword">new</span> BABYLON.StandardMaterial(<span class="string">"groundMat"</span>, scene);<span class="comment">//泥土材质</span></div><div class="line">    groundMaterial.diffuseTexture = <span class="keyword">new</span> BABYLON.Texture(<span class="string">"../IMAGE/tree.png"</span>, scene);<span class="comment">//地面的纹理贴图</span></div><div class="line">    groundMaterial.diffuseTexture.uScale = <span class="number">50.0</span>;<span class="comment">//纹理重复效果</span></div><div class="line">    groundMaterial.diffuseTexture.vScale = <span class="number">50.0</span>;</div><div class="line">    ground.material = groundMaterial;</div><div class="line">    ground.checkCollisions = <span class="literal">true</span>;<span class="comment">//检测碰撞</span></div><div class="line">    ground.receiveShadows = <span class="literal">true</span>;<span class="comment">//接收影子</span></div><div class="line"></div><div class="line">    <span class="comment">//墙</span></div><div class="line">    <span class="keyword">var</span> Mur = BABYLON.Mesh.CreateBox(<span class="string">"Mur"</span>, <span class="number">1</span>, scene);</div><div class="line">    Mur.scaling = <span class="keyword">new</span> BABYLON.Vector3(<span class="number">15</span>, <span class="number">6</span>, <span class="number">1</span>);</div><div class="line">    Mur.position.y = <span class="number">20</span>;</div><div class="line">    Mur.position.z = <span class="number">20</span>;</div><div class="line">    Mur.checkCollisions = <span class="literal">true</span>;</div></pre></td></tr></table></figure>
<p>其中各个方法的具体用法可以参考官方的基础教程</p>
<h3 id="2、接下来是在场景中导入第一个人物的骨骼模型："><a href="#2、接下来是在场景中导入第一个人物的骨骼模型：" class="headerlink" title="2、接下来是在场景中导入第一个人物的骨骼模型："></a>2、接下来是在场景中导入第一个人物的骨骼模型：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//角色导入，加载哪个mesh、文件目录、文件名、加入场景、回调函数</span></div><div class="line">    BABYLON.SceneLoader.ImportMesh(<span class="string">""</span>, <span class="string">"../MODEL/him/"</span>, <span class="string">"him.babylon"</span>, scene, <span class="function"><span class="keyword">function</span> (<span class="params">newMeshes, particleSystems, skeletons</span>)</span></div><div class="line">    &#123;<span class="comment">//载入完成的回调函数</span></div><div class="line">        <span class="keyword">var</span> Tom=<span class="keyword">new</span> Player;</div><div class="line">        <span class="keyword">var</span> obj_p=&#123;&#125;;<span class="comment">//初始化参数对象</span></div><div class="line">        obj_p.mesh=newMeshes[<span class="number">0</span>];<span class="comment">//网格数据</span></div><div class="line">        obj_p.scaling=<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0.05</span>, <span class="number">0.05</span>, <span class="number">0.05</span>);<span class="comment">//缩放</span></div><div class="line">        obj_p.position=<span class="keyword">new</span> BABYLON.Vector3(<span class="number">-5.168</span>, <span class="number">30.392</span>, <span class="number">-7.463</span>);<span class="comment">//位置</span></div><div class="line">        obj_p.rotation=<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">3.9</span>, <span class="number">0</span>);<span class="comment">// 旋转</span></div><div class="line">        obj_p.checkCollisions=<span class="literal">true</span>;<span class="comment">//使用默认的碰撞检测</span></div><div class="line">        obj_p.ellipsoid=<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0.5</span>, <span class="number">1</span>, <span class="number">0.5</span>);<span class="comment">//碰撞检测椭球</span></div><div class="line">        obj_p.ellipsoidOffset=<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);<span class="comment">//碰撞检测椭球位移</span></div><div class="line">        obj_p.skeletonsPlayer=skeletons;</div><div class="line">        obj_p.methodofmove=<span class="string">"controlwitha"</span>;</div><div class="line">        obj_p.name=username;</div><div class="line">        obj_p.id=id;</div><div class="line">        obj_p.p1=<span class="string">""</span>;</div><div class="line">        obj_p.p2=<span class="string">"../MODEL/him/"</span>;</div><div class="line">        obj_p.p3=<span class="string">"him.babylon"</span>;</div><div class="line">        <span class="keyword">var</span> len=newMeshes.length;<span class="comment">//对于复杂的模型来说newMeshes的其他部分也必须保存下来</span></div><div class="line">        <span class="keyword">var</span> arr=[];</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">1</span>;i&lt;len;i++)</div><div class="line">        &#123;</div><div class="line">            arr.push(newMeshes[i]);</div><div class="line">        &#125;</div><div class="line">        obj_p.submeshs=arr;</div><div class="line"></div><div class="line">        Tom.init(</div><div class="line">            obj_p</div><div class="line">        );</div><div class="line">        arr_myplayers[username]=Tom;</div><div class="line"></div><div class="line">        <span class="keyword">if</span>(state==<span class="string">"online"</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> arr=[];</div><div class="line">            arr.push(<span class="string">"addnewplayer"</span>);</div><div class="line">            arr.push(Tom.mesh.scaling.x);</div><div class="line">            arr.push(Tom.mesh.scaling.y);</div><div class="line">            arr.push(Tom.mesh.scaling.z);</div><div class="line">            arr.push(Tom.mesh.position.x);</div><div class="line">            arr.push(Tom.mesh.position.y);</div><div class="line">            arr.push(Tom.mesh.position.z);</div><div class="line">            arr.push(Tom.mesh.rotation.x);</div><div class="line">            arr.push(Tom.mesh.rotation.y);</div><div class="line">            arr.push(Tom.mesh.rotation.z);</div><div class="line">            arr.push(Tom.p1);</div><div class="line">            arr.push(Tom.p2);</div><div class="line">            arr.push(Tom.p3);</div><div class="line">            arr.push(Tom.meshname);</div><div class="line">            <span class="keyword">var</span> dt=<span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">            <span class="built_in">console</span>.log(dt.getTime()+<span class="string">"send addnewplayer"</span>+id);</div><div class="line">            doSend(arr.join(<span class="string">"@"</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        cameraArcRotative[<span class="number">0</span>].alpha = -<span class="built_in">parseFloat</span>(arr_myplayers[username].mesh.rotation.y) - <span class="number">4.69</span>;<span class="comment">//初始化相机角度</span></div><div class="line"></div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>   其中BABYLON.SceneLoader.ImportMesh是一个异步的把服务器端场景文件导入本地内存的方法，第一个参数表示导入场景文件中的哪一个Mesh，为空表示都导入（一个场景文件里可能包含多个模型，但该示例中的场景文件里只有一个模型，所以也叫做模型文件），第二个参数是文件所在的相对路径，第三个参数是文件名，第四个参数是文件加入的场景，第五个参数是导入完成后的回调函数。<br>　　回调函数的newMeshes参数是所有导入的Mesh组成的数组，skeletons参数是所有导入的骨骼动画数组。事实上一个模型可能由多个mesh组合而成，比如示例中的him模型的newMeshes[0]只是一个空壳，newMeshes[1]到newMeshes[5]才是模型各个部分的实际Mesh，后五个Mesh是newMeshes[0]的“submesh”，newMeshes[0]是后五个Mesh的parent，在理想情况下这些Mesh之间的关系和Mesh与骨骼动画（skeleton）之间的关系由Babylon引擎自动管理。<br>　　在回调函数中，定义Tom为一个Player“类”对象，第五行定义的obj_p对象是Player对象的初始化参数对象，Player.init()方法定义在player.js文件中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//玩家对象</span></div><div class="line">Player=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    sdyq.object.call(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line">Player.prototype=<span class="keyword">new</span> sdyq.object();</div><div class="line">Player.prototype.init=<span class="function"><span class="keyword">function</span>(<span class="params">param</span>)</span></div><div class="line">&#123;</div><div class="line">    param = param || &#123;&#125;;</div><div class="line">    sdyq.object.prototype.init.call(<span class="keyword">this</span>,param);<span class="comment">//继承原型的方法</span></div><div class="line">    <span class="keyword">this</span>.flag_standonground=<span class="number">0</span>;<span class="comment">//是否接触地面</span></div><div class="line">    <span class="keyword">this</span>.keys=&#123;w:<span class="number">0</span>,s:<span class="number">0</span>,a:<span class="number">0</span>,d:<span class="number">0</span>,space:<span class="number">0</span>,ctrl:<span class="number">0</span>,shift:<span class="number">0</span>&#125;;<span class="comment">//按键是否保持按下，考虑到多客户端并行，那么势必每个player都有自己的keys！！</span></div><div class="line">    <span class="keyword">this</span>.flag_runfast=<span class="number">1</span>;<span class="comment">//加快速度</span></div><div class="line">    <span class="keyword">this</span>.name=param.name;</div><div class="line">    <span class="keyword">this</span>.id=param.id;</div><div class="line">    <span class="keyword">this</span>.p1=param.p1;</div><div class="line">    <span class="keyword">this</span>.p2=param.p2;</div><div class="line">    <span class="keyword">this</span>.p3=param.p3;</div></pre></td></tr></table></figure></p>
<p>　　可以看到Player对象继承自sdyq.object对象，Player对象的原型是sdyq.object对象，在Player对象的init方法中，先初始化属于原型的属性，再初始化自己这个“类”新添加的属性。<br>　　sdyq.object对象的定义在Sdyq.js文件中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//物体本身的属性和初始化</span></div><div class="line">sdyq=&#123;&#125;;<span class="comment">//3D引擎</span></div><div class="line">sdyq.object=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line">&#123;<span class="comment">//在地面上加速度运动的物体</span></div><div class="line"></div><div class="line">&#125;</div><div class="line">sdyq.object.prototype.init = <span class="function"><span class="keyword">function</span>(<span class="params">param</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">this</span>.keys=&#123;w:<span class="number">0</span>,s:<span class="number">0</span>,a:<span class="number">0</span>,d:<span class="number">0</span>,space:<span class="number">0</span>,ctrl:<span class="number">0</span>,shift:<span class="number">0</span>&#125;;<span class="comment">//按键是否保持按下</span></div><div class="line">    <span class="keyword">this</span>.witha0=&#123;forward:<span class="number">0</span>,left:<span class="number">0</span>,up:<span class="number">-9.82</span>&#125;;<span class="comment">//非键盘控制产生的加速度</span></div><div class="line">    <span class="keyword">this</span>.witha=&#123;forward:<span class="number">0</span>,left:<span class="number">0</span>,up:<span class="number">-9.82</span>&#125;;<span class="comment">//环境加速度，包括地面阻力和重力，现在还没有风力</span></div><div class="line">    <span class="keyword">this</span>.witha2=&#123;forward:<span class="number">0</span>,left:<span class="number">0</span>,up:<span class="number">0</span>&#125;;<span class="comment">//键盘控制加速度与物体本身加速度和非键盘控制产生的加速度合并后的最终加速度</span></div><div class="line">    <span class="keyword">this</span>.v0=&#123;forward:<span class="number">0</span>,left:<span class="number">0</span>,up:<span class="number">0</span>&#125;;<span class="comment">//上一时刻的速度</span></div><div class="line">    <span class="keyword">this</span>.vt=&#123;forward:<span class="number">0</span>,left:<span class="number">0</span>,up:<span class="number">0</span>&#125;;<span class="comment">//下一时刻的速度</span></div><div class="line">    <span class="keyword">this</span>.vm=&#123;forward:<span class="number">15</span>,backwards:<span class="number">5</span>,left:<span class="number">5</span>,right:<span class="number">5</span>,up:<span class="number">100</span>,down:<span class="number">100</span>&#125;;<span class="comment">//各个方向的最大速度</span></div><div class="line">    <span class="comment">//this.flag_song=0;//是否接触地面</span></div><div class="line">    <span class="keyword">this</span>.flag_runfast=<span class="number">1</span>;<span class="comment">//加快速度</span></div><div class="line">    <span class="keyword">this</span>.ry0=<span class="number">0</span>;<span class="comment">//上一时刻的y轴转角</span></div><div class="line">    <span class="keyword">this</span>.ryt=<span class="number">0</span>;<span class="comment">//下一时刻的y轴转角</span></div><div class="line">    <span class="keyword">this</span>.rychange=<span class="number">0</span>;<span class="comment">//y轴转角差</span></div><div class="line">    <span class="keyword">this</span>.mchange=&#123;forward:<span class="number">0</span>,left:<span class="number">0</span>,up:<span class="number">0</span>&#125;;<span class="comment">//物体自身坐标系上的位移</span></div><div class="line">    <span class="keyword">this</span>.vmove=<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);<span class="comment">//世界坐标系中每一时刻的位移和量</span></div><div class="line">    <span class="keyword">this</span>.py0=<span class="number">0</span>;<span class="comment">//记录上一时刻的y轴位置，和下一时刻比较确定物体有没有继续向下运动！！</span></div><div class="line"></div><div class="line">    param = param || &#123;&#125;;</div><div class="line">    <span class="keyword">this</span>.mesh=param.mesh;</div><div class="line">    <span class="keyword">this</span>.mesh.scaling=param.scaling;</div><div class="line">    <span class="keyword">this</span>.mesh.position=param.position;</div><div class="line">    <span class="keyword">this</span>.mesh.rotation=param.rotation;</div><div class="line">    <span class="keyword">this</span>.mesh.checkCollisions=param.checkCollisions;</div><div class="line">    <span class="keyword">this</span>.mesh.ellipsoid=param.ellipsoid;</div><div class="line">    <span class="keyword">this</span>.mesh.ellipsoidOffset=param.ellipsoidOffset;</div><div class="line">    <span class="keyword">this</span>.meshname=<span class="keyword">this</span>.mesh.name;</div><div class="line">    <span class="keyword">this</span>.skeletonsPlayer=param.skeletonsPlayer||[];</div><div class="line">    <span class="keyword">this</span>.submeshs=param.submeshs;</div><div class="line">    <span class="keyword">this</span>.ry0=param.mesh.rotation.y;</div><div class="line">    <span class="keyword">this</span>.py0=param.mesh.position.y;</div><div class="line">    <span class="keyword">this</span>.countstop=<span class="number">0</span>;<span class="comment">//记录物体静止了几次，如果物体一直静止就停止发送运动信息</span></div><div class="line"></div><div class="line">    <span class="keyword">this</span>.PlayAnnimation = <span class="literal">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.methodofmove=param.methodofmove||<span class="string">""</span>;</div><div class="line">    <span class="keyword">switch</span>(<span class="keyword">this</span>.methodofmove)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">"controlwitha"</span>:</div><div class="line">        &#123;</div><div class="line">            <span class="built_in">window</span>.addEventListener(<span class="string">"keydown"</span>, onKeyDown, <span class="literal">false</span>);<span class="comment">//按键按下</span></div><div class="line">            <span class="built_in">window</span>.addEventListener(<span class="string">"keyup"</span>, onKeyUp, <span class="literal">false</span>);<span class="comment">//按键抬起</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">default</span> :</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>　　sdyq.object对象的初始化方法中包含了对mesh姿态的详细设定、对键盘操作的监听设定和适用于加速度运动的各项参数设定，各种加速度运动的物体都可以用sdyq.object对象来扩展产生。<br>　　在Player对象的初始化方法中还为每个玩家添加了id显示（头上的那个数字）：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//在玩家头上显示名字，clone时这个也会被clone过去，要处理一下！！！！</span></div><div class="line">    <span class="keyword">var</span> lab_texture=<span class="keyword">new</span> BABYLON.Texture.CreateFromBase64String(texttoimg2(<span class="keyword">this</span>.id),<span class="string">"datatexture"</span>+<span class="keyword">this</span>.id,scene);<span class="comment">//使用canvas纹理！！</span></div><div class="line">    <span class="keyword">var</span> materialSphere1 = <span class="keyword">new</span> BABYLON.StandardMaterial(<span class="string">"texture1"</span>+<span class="keyword">this</span>.id, scene);</div><div class="line">    materialSphere1.diffuseTexture = lab_texture;</div><div class="line">    <span class="keyword">var</span> plane = BABYLON.Mesh.CreatePlane(<span class="string">"plane"</span>+<span class="keyword">this</span>.id, <span class="number">2.0</span>, scene, <span class="literal">false</span>, BABYLON.Mesh.FRONTSIDE);</div><div class="line">    <span class="comment">//You can also set the mesh side orientation with the values : BABYLON.Mesh.FRONTSIDE (default), BABYLON.Mesh.BACKSIDE or BABYLON.Mesh.DOUBLESIDE</span></div><div class="line">    materialSphere1.diffuseTexture.hasAlpha = <span class="literal">true</span>;<span class="comment">//应用纹理的透明度</span></div><div class="line"></div><div class="line">    plane.position=<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>,<span class="number">75</span>,<span class="number">0</span>);<span class="comment">//其父元素应用过0.05之缩放，故而这里位移量要*20</span></div><div class="line">    plane.rotation.y = <span class="built_in">Math</span>.PI;</div><div class="line">    plane.scaling.x=<span class="number">20</span>;</div><div class="line">    plane.scaling.y=<span class="number">4</span>;</div><div class="line">    plane.parent=<span class="keyword">this</span>.mesh;</div><div class="line"></div><div class="line">    plane.material=materialSphere1;</div><div class="line">    <span class="keyword">this</span>.lab=plane;</div></pre></td></tr></table></figure></p>
<p>　　在这里使用了canvas现场产生纹理（术语叫“程序贴图”），其中texttoimg2（）方法的定义在utils.js文件中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//把文字转变为图片jpeg</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">texttoimg</span>(<span class="params">str</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> c=<span class="built_in">document</span>.createElement(<span class="string">"canvas"</span>);</div><div class="line">    c.height=<span class="number">20</span>;</div><div class="line">    c.width=<span class="number">100</span>;</div><div class="line">    <span class="keyword">var</span> context = c.getContext(<span class="string">'2d'</span>);</div><div class="line">    context.font=<span class="string">"normal 15px sans-serif"</span>;</div><div class="line">    context.clearRect(<span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height);</div><div class="line">    context.fillStyle=<span class="string">"rgb(255,255,255)"</span>;</div><div class="line">    context.fillRect(<span class="number">0</span>,<span class="number">0</span>,canvas.width,canvas.height);</div><div class="line">    context.fillStyle = <span class="string">"rgb(0,0,0)"</span>;</div><div class="line">    context.textBaseline = <span class="string">'top'</span>;</div><div class="line">    context.fillText(str,(c.width-str.length*<span class="number">15</span>)/<span class="number">2</span>,<span class="number">0</span>, c.width*<span class="number">0.9</span>);</div><div class="line">    <span class="keyword">var</span> str_src=c.toDataURL(<span class="string">"image/jpeg"</span>);</div><div class="line">    <span class="keyword">return</span> str_src;</div><div class="line">    <span class="comment">//return c;</span></div><div class="line">&#125;</div><div class="line"><span class="comment">//把文字转变为图片PNG</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">texttoimg2</span>(<span class="params">str</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> c=<span class="built_in">document</span>.createElement(<span class="string">"canvas"</span>);</div><div class="line">    c.height=<span class="number">20</span>;</div><div class="line">    c.width=<span class="number">100</span>;</div><div class="line">    <span class="keyword">var</span> context = c.getContext(<span class="string">'2d'</span>);</div><div class="line">    context.font=<span class="string">"normal 20px sans-serif"</span>;</div><div class="line">    context.clearRect(<span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height);</div><div class="line">    <span class="comment">//context.fillStyle="rgb(255,255,255)";</span></div><div class="line">    <span class="comment">//context.fillRect(0,0,canvas.width,canvas.height);</span></div><div class="line">    context.fillStyle = <span class="string">"rgb(255,255,255)"</span>;</div><div class="line">    context.textBaseline = <span class="string">'middle'</span>;<span class="comment">//</span></div><div class="line">    context.fillText(str,(c.width-str.length*<span class="number">20</span>)/<span class="number">2</span>,<span class="number">10</span>, c.width*<span class="number">0.9</span>);</div><div class="line">    <span class="keyword">var</span> str_src=c.toDataURL(<span class="string">"image/png"</span>);</div><div class="line">    <span class="keyword">return</span> str_src;</div><div class="line">    <span class="comment">//return c;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>　　该代码综合网上多个教程修改而来，其中生成jpeg的难点在于canvas默认生成四通道图像，而jpeg在去除透明度通道时会自动将透明度通道变成黑色，于是jpeg一片漆黑，解决方法是先画一个不透明的白色矩形背景，挡住所有透明通道，再在白色背景上画图。<br>　　在模型导入完毕后把Tom设为玩家列表对象arr_myplayers的一个属性，如果当前玩家处于在线状态，则还要把其加载状态同步给其他玩家，具体同步方式稍后介绍。<br>　　最后把玩家的相机定位到玩家模型的身后，做第三方跟随视角状。</p>
<h2 id="三、加速度运动控制"><a href="#三、加速度运动控制" class="headerlink" title="三、加速度运动控制"></a>三、加速度运动控制</h2><p>在scene_link.js文件的中部可以看到scene.registerBeforeRender()方法，这个方法的作用是在每次渲染前调用作为它的参数的方法，我们通过这个方法在每次渲染前对物体的下一步运动情况进行计算：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line">scene.registerBeforeRender(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line">    &#123;<span class="comment">//每次渲染前</span></div><div class="line">        <span class="keyword">if</span>(scene.isReady() &amp;amp;&amp;amp; arr_myplayers)</div><div class="line">        &#123;<span class="comment">//场景加载完毕</span></div><div class="line">            <span class="keyword">if</span>(sceneCharger == <span class="literal">false</span>) &#123;</div><div class="line">                engine.hideLoadingUI();<span class="comment">//隐藏载入ui</span></div><div class="line">                sceneCharger = <span class="literal">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span>(ms0==<span class="number">0</span>)</div><div class="line">            &#123;<span class="comment">//最开始，等一帧</span></div><div class="line">                ms0=<span class="keyword">new</span> <span class="built_in">Date</span>();<span class="comment">//设置初始时间</span></div><div class="line">                schange=<span class="number">0</span>;<span class="comment">//初始化时间差</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                mst = <span class="keyword">new</span> <span class="built_in">Date</span>();<span class="comment">//下一时刻</span></div><div class="line">                schange = (mst - ms0) / <span class="number">1000</span>;</div><div class="line">                ms0=mst;<span class="comment">//时间越过</span></div><div class="line">                <span class="comment">//对于这段时间内的每一个物体</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> arr_myplayers)<span class="comment">//该客户端所控制的物体</span></div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">var</span> obj = arr_myplayers[key];</div><div class="line">                    <span class="keyword">switch</span>(obj.methodofmove)</div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">case</span> <span class="string">"controlwitha"</span>:</div><div class="line">                        &#123;</div><div class="line">                            movewitha(obj);</div><div class="line">                            <span class="comment">//这里加上dosend！！！！，原地不动也发送吗？</span></div><div class="line">                            <span class="keyword">if</span> (state == <span class="string">"online"</span>)</div><div class="line">                            &#123;</div><div class="line">                                <span class="keyword">if</span>(obj.vmove.x==<span class="number">0</span>&amp;amp;&amp;amp;obj.vmove.y==<span class="number">0</span>&amp;amp;&amp;amp;obj.vmove.z==<span class="number">0</span>&amp;amp;&amp;amp;obj.rychange==<span class="number">0</span>)</div><div class="line">                                &#123;<span class="comment">//如果位置和姿态不变</span></div><div class="line">                                    <span class="keyword">if</span>(obj.countstop&gt;<span class="number">0</span>)</div><div class="line">                                    &#123;<span class="comment">//一直静止则不发送运动信息</span></div><div class="line"></div><div class="line">                                    &#125;</div><div class="line">                                    <span class="keyword">else</span></div><div class="line">                                    &#123;</div><div class="line">                                        obj.countstop+=<span class="number">1</span>;</div><div class="line">                                        <span class="comment">//当前位置，当前角度，当前移动，当前姿态变化</span></div><div class="line">                                        <span class="keyword">var</span> arr = [];</div><div class="line">                                        arr.push(<span class="string">"updatemesh"</span>);</div><div class="line">                                        arr.push(obj.mesh.position.x);</div><div class="line">                                        arr.push(obj.mesh.position.y);</div><div class="line">                                        arr.push(obj.mesh.position.z);</div><div class="line">                                        arr.push(obj.mesh.rotation.x);</div><div class="line">                                        arr.push(obj.mesh.rotation.y);</div><div class="line">                                        arr.push(obj.mesh.rotation.z);</div><div class="line">                                        arr.push(obj.vmove.x);</div><div class="line">                                        arr.push(obj.vmove.y);</div><div class="line">                                        arr.push(obj.vmove.z);</div><div class="line">                                        arr.push(obj.rychange);</div><div class="line">                                        doSend(arr.join(<span class="string">"@"</span>));</div><div class="line">                                    &#125;</div><div class="line">                                &#125;</div><div class="line">                                <span class="keyword">else</span></div><div class="line">                                &#123;</div><div class="line">                                    obj.countstop=<span class="number">0</span>;</div><div class="line">                                    <span class="comment">//当前位置，当前角度，当前移动，当前姿态变化</span></div><div class="line">                                    <span class="keyword">var</span> arr = [];</div><div class="line">                                    arr.push(<span class="string">"updatemesh"</span>);</div><div class="line">                                    arr.push(obj.mesh.position.x);</div><div class="line">                                    arr.push(obj.mesh.position.y);</div><div class="line">                                    arr.push(obj.mesh.position.z);</div><div class="line">                                    arr.push(obj.mesh.rotation.x);</div><div class="line">                                    arr.push(obj.mesh.rotation.y);</div><div class="line">                                    arr.push(obj.mesh.rotation.z);</div><div class="line">                                    arr.push(obj.vmove.x);</div><div class="line">                                    arr.push(obj.vmove.y);</div><div class="line">                                    arr.push(obj.vmove.z);</div><div class="line">                                    arr.push(obj.rychange);</div><div class="line">                                    doSend(arr.join(<span class="string">"@"</span>));</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            <span class="keyword">if</span>((obj.vmove.x!=<span class="number">0</span>||obj.vmove.y!=<span class="number">0</span>||obj.vmove.z!=<span class="number">0</span>||obj.rychange!=<span class="number">0</span>)&amp;amp;&amp;amp;obj.PlayAnnimation==<span class="literal">false</span>)</div><div class="line">                            &#123;<span class="comment">//如果开始运动，启动骨骼动画</span></div><div class="line">                                obj.PlayAnnimation=<span class="literal">true</span>;</div><div class="line">                                obj.beginSP(<span class="number">0</span>);</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">else</span> <span class="keyword">if</span>(obj.vmove.x==<span class="number">0</span>&amp;amp;&amp;amp;obj.vmove.y==<span class="number">0</span>&amp;amp;&amp;amp;obj.vmove.z==<span class="number">0</span>&amp;amp;&amp;amp;obj.rychange==<span class="number">0</span>&amp;amp;&amp;amp;obj.PlayAnnimation==<span class="literal">true</span>)</div><div class="line">                            &#123;<span class="comment">//如果运动结束，关闭骨骼动画</span></div><div class="line">                                obj.PlayAnnimation=<span class="literal">false</span>;</div><div class="line">                                scene.stopAnimation(obj.skeletonsPlayer[<span class="number">0</span>]);</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">default</span> :</div><div class="line">                        &#123;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">。。。</div></pre></td></tr></table></figure>
<p>　　这里的意思是说如果玩家列表里的玩家的运动方式(methodofmove)是”controlwitha”，则使用movewitha(obj)方法计算其在这一时间段中的运动，当然，如果编写出了其他的运动方法也可以类似的扩展进来。<br>　　movewitha(obj)方法定义在MoveWeb.js文件中：</p>
<h3 id="1、初速度投影"><a href="#1、初速度投影" class="headerlink" title="1、初速度投影"></a>1、初速度投影</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">movewitha</span>(<span class="params">obj</span>)//地面上带有加速度的运动，必须站在地上才能加速，与宇宙空间中的喷气式加速度相比较</span></div><div class="line">&#123;</div><div class="line">    obj.ryt=obj.mesh.rotation.y;</div><div class="line">    obj.rychange=<span class="built_in">parseFloat</span>(obj.ryt - obj.ry0);</div><div class="line">    obj.ry0=obj.ryt;</div><div class="line">    <span class="comment">//将上一时刻的速度投影到下一时刻的坐标里</span></div><div class="line">    <span class="keyword">var</span> v0t = &#123;forward: <span class="number">0</span>, left: <span class="number">0</span>, up: <span class="number">0</span>&#125;;</div><div class="line">    v0t.forward = obj.v0.forward * <span class="built_in">parseFloat</span>(<span class="built_in">Math</span>.cos(obj.rychange)) + (-obj.v0.left * <span class="built_in">parseFloat</span>(<span class="built_in">Math</span>.sin(obj.rychange)));</div><div class="line">    v0t.left = (obj.v0.forward * <span class="built_in">parseFloat</span>(<span class="built_in">Math</span>.sin(obj.rychange))) + (obj.v0.left * <span class="built_in">parseFloat</span>(<span class="built_in">Math</span>.cos(obj.rychange)));</div><div class="line">    v0t.up = obj.v0.up;</div><div class="line">    obj.v0 = v0t;</div></pre></td></tr></table></figure>
<p>　　物体在这一小段时间内可能绕y轴转过了一定角度，所以要把物体在上一时刻的自身坐标系速度投影到经过变化之后的自身坐标系中。</p>
<h3 id="2、计算水平加速度，与水平位移"><a href="#2、计算水平加速度，与水平位移" class="headerlink" title="2、计算水平加速度，与水平位移"></a>2、计算水平加速度，与水平位移</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//计算水平加速度</span></div><div class="line">    <span class="keyword">if</span>(obj.flag_standonground==<span class="number">1</span>)<span class="comment">//在地面上才能使用水平加速度</span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">//移动速度产生的阻力，只考虑地面阻力，不考虑空气阻力</span></div><div class="line">        <span class="keyword">if</span> (obj.v0.forward == <span class="number">0</span>) &#123;</div><div class="line">            obj.witha.forward = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (obj.v0.forward &gt; <span class="number">0</span>) &#123;</div><div class="line">            obj.witha.forward = <span class="number">-0.5</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            obj.witha.forward = <span class="number">0.5</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (obj.v0.left == <span class="number">0</span>) &#123;</div><div class="line">            obj.witha.left = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (obj.v0.left &gt; <span class="number">0</span>) &#123;</div><div class="line">            obj.witha.left = <span class="number">-0.5</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            obj.witha.left = <span class="number">0.5</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//最终加速度由环境加速度和物体自身加速度叠加而成</span></div><div class="line">        obj.witha2.forward = obj.witha.forward+obj.witha0.forward;</div><div class="line">        obj.witha2.left = obj.witha.left+obj.witha0.left;</div><div class="line">        <span class="comment">//根据键盘操作设置加速度</span></div><div class="line">        <span class="comment">//处理前后</span></div><div class="line">        <span class="keyword">if</span> (obj.keys.w != <span class="number">0</span>) &#123;</div><div class="line">            obj.witha2.forward += <span class="number">5</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (obj.keys.s != <span class="number">0</span>) &#123;</div><div class="line">            obj.witha2.forward -= <span class="number">2</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//处理左右</span></div><div class="line">        <span class="keyword">if</span> (obj.keys.a != <span class="number">0</span> &amp;amp;&amp;amp; obj.keys.d != <span class="number">0</span>) &#123;<span class="comment">//同时按下左右键则什么也不做</span></div><div class="line"></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (obj.keys.a != <span class="number">0</span>) &#123;</div><div class="line">            obj.witha2.left += <span class="number">2</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (obj.keys.d != <span class="number">0</span>) &#123;</div><div class="line">            obj.witha2.left -= <span class="number">2</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        obj.witha2.forward=<span class="number">0</span>;</div><div class="line">        obj.witha2.left=<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//根据水平加速度计算水平运动</span></div><div class="line">    <span class="keyword">if</span>(obj.witha2.forward!=<span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        obj.vt.forward = obj.v0.forward + obj.witha2.forward * schange;<span class="comment">//速度变化</span></div><div class="line">        <span class="keyword">if</span>((<span class="number">0</span> &lt; obj.vt.forward &amp;amp;&amp;amp; obj.vt.forward &lt; obj.vm.forward) || (<span class="number">0</span> &gt; obj.vt.forward &amp;amp;&amp;amp; obj.vt.forward &gt; -obj.vm.backwards))</div><div class="line">        &#123;<span class="comment">//在最大速度范围内</span></div><div class="line">            obj.mchange.forward = obj.witha2.forward * schange * schange + obj.v0.forward * schange;<span class="comment">//加速度产生的距离变化</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (obj.vm.forward &lt;= obj.vt.forward) &#123;<span class="comment">//超出最大速度则按最大速度算</span></div><div class="line">            obj.vt.forward = obj.vm.forward;</div><div class="line">            obj.mchange.forward = obj.vt.forward * schange;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (-obj.vm.backwards &gt;= obj.vt.forward) &#123;</div><div class="line">            obj.vt.forward = -obj.vm.backwards;</div><div class="line">            obj.mchange.forward = obj.vt.forward * schange;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;<span class="comment">//无加速度时匀速运动</span></div><div class="line">        obj.mchange.forward = obj.v0.forward * schange;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(obj.witha2.left!=<span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        obj.vt.left = obj.v0.left + obj.witha2.left * schange;<span class="comment">//速度变化</span></div><div class="line">        <span class="keyword">if</span>((<span class="number">0</span> &lt; obj.vt.left &amp;amp;&amp;amp; obj.vt.left &lt; obj.vm.left) || (<span class="number">0</span> &gt; obj.vt.left &amp;amp;&amp;amp; obj.vt.left &gt; -obj.vm.right))</div><div class="line">        &#123;<span class="comment">//在最大速度范围内</span></div><div class="line">            obj.mchange.left = obj.witha2.left * schange * schange + obj.v0.left * schange;<span class="comment">//加速度产生的距离变化</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (obj.vm.left &lt;= obj.vt.left) &#123;</div><div class="line">            obj.vt.left = obj.vm.left;</div><div class="line">            obj.mchange.left = obj.vt.left * schange;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (-obj.vm.right &gt;= obj.vt.left) &#123;</div><div class="line">            obj.vt.left = -obj.vm.right;</div><div class="line">            obj.mchange.left = obj.vt.left * schange;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        obj.mchange.left = obj.v0.left * schange;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="3、计算垂直加速度、垂直位移："><a href="#3、计算垂直加速度、垂直位移：" class="headerlink" title="3、计算垂直加速度、垂直位移："></a>3、计算垂直加速度、垂直位移：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//垂直加速度单独计算</span></div><div class="line"></div><div class="line">    <span class="comment">//正在下落，但没有下落应有的距离</span></div><div class="line">    <span class="keyword">if</span>(obj.v0.up&lt;<span class="number">0</span>&amp;amp;&amp;amp;obj.flag_standonground==<span class="number">0</span>&amp;amp;&amp;amp;((obj.py0-obj.mesh.position.y)&lt;(-obj.mchange.up)/<span class="number">5</span>))</div><div class="line">    &#123;</div><div class="line">        obj.v0.up=<span class="number">0</span>;</div><div class="line">        obj.flag_standonground=<span class="number">1</span>;<span class="comment">//表示接触地面</span></div><div class="line">        obj.witha.up=<span class="number">-0.5</span>;<span class="comment">//考虑到下坡的存在，还要有一点向下的分量，使其能够沿地面向下但又不至于抖动过于剧烈</span></div><div class="line">        obj.vm.up=<span class="number">5</span>;</div><div class="line">        obj.vm.down=<span class="number">5</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(obj.flag_standonground==<span class="number">1</span>&amp;amp;&amp;amp;((obj.py0-obj.mesh.position.y)&gt;(-obj.mchange.up)/<span class="number">5</span>))<span class="comment">//遇到了一个坑</span></div><div class="line">    &#123;</div><div class="line">        obj.flag_standonground=<span class="number">0</span>;</div><div class="line">        obj.witha.up=<span class="number">-9.82</span>;</div><div class="line">        obj.vm.up=<span class="number">100</span>;</div><div class="line">        obj.vm.down=<span class="number">100</span>;</div><div class="line">    &#125;</div><div class="line">    obj.witha2.up = obj.witha.up;</div><div class="line">    <span class="keyword">if</span> (obj.witha2.up != <span class="number">0</span>&amp;amp;&amp;amp;(obj.flag_standonground==<span class="number">0</span>||(obj.flag_standonground==<span class="number">1</span>&amp;amp;&amp;amp;(obj.mchange.left!=<span class="number">0</span>||obj.mchange.forward!=<span class="number">0</span>)))) &#123;<span class="comment">//不在地面或者有水平位移才考虑上下加速移动</span></div><div class="line"></div><div class="line">        obj.vt.up = obj.v0.up + obj.witha2.up * schange;<span class="comment">//速度变化</span></div><div class="line">        <span class="keyword">if</span> ((<span class="number">0</span> &lt; obj.vt.up &amp;amp;&amp;amp; obj.vt.up &lt; obj.vm.up) || (<span class="number">0</span> &gt; obj.vt.up &amp;amp;&amp;amp; obj.vt.up &gt; -obj.vm.down)) &#123;</div><div class="line">            obj.mchange.up = obj.witha2.up * schange * schange + obj.v0.up * schange;<span class="comment">//加速度产生的距离变化</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (obj.vm.up &lt;= obj.vt.up) &#123;</div><div class="line">            obj.vt.up = obj.vm.up;</div><div class="line">            obj.mchange.up = obj.vt.up * schange;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (-obj.vm.down &gt;= obj.vt.up) &#123;</div><div class="line">            obj.vt.up = -obj.vm.down;</div><div class="line">            obj.mchange.up = obj.vt.up * schange;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        obj.mchange.up = obj.v0.up * schange;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>　　Babylon初级教程中提供了两种现成的碰撞检测方法，其中一种能够较精确的检测到物体掉落在地面上，但不支持事件响应或者回调函数；另一种支持事件响应，但物体的碰撞检测边界太过粗糙，无法精确检测碰撞。所以我只好用“有没有在该方向上移动应有的距离”来暂时代替碰撞检测。</p>
<h3 id="4、应用位移："><a href="#4、应用位移：" class="headerlink" title="4、应用位移："></a>4、应用位移：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//旧的当前速度没用了，更新当前速度</span></div><div class="line">    obj.v0.forward = obj.vt.forward;</div><div class="line">    obj.v0.left = obj.vt.left;</div><div class="line">    obj.v0.up = obj.vt.up;</div><div class="line">    <span class="comment">//取消过于微小的速度和位移</span></div><div class="line">    <span class="keyword">if</span> (obj.v0.forward &lt; <span class="number">0.002</span> &amp;amp;&amp;amp; obj.v0.forward &gt; <span class="number">-0.002</span>) &#123;</div><div class="line">        obj.v0.forward = <span class="number">0</span>;</div><div class="line">        obj.mchange.forward=<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (obj.v0.left &lt; <span class="number">0.002</span> &amp;amp;&amp;amp; obj.v0.left &gt; <span class="number">-0.002</span>) &#123;</div><div class="line">        obj.v0.left = <span class="number">0</span>;</div><div class="line">        obj.mchange.left=<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (obj.v0.up &lt; <span class="number">0.002</span> &amp;amp;&amp;amp; obj.v0.up &gt; <span class="number">-0.002</span>) &#123;</div><div class="line">        obj.v0.up = <span class="number">0</span>;</div><div class="line">        obj.mchange.up=<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(obj.mchange.forward&lt;<span class="number">0.002</span>&amp;amp;&amp;amp; obj.mchange.forward &gt; <span class="number">-0.002</span>)</div><div class="line">    &#123;</div><div class="line">        obj.mchange.forward=<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(obj.mchange.left&lt;<span class="number">0.002</span>&amp;amp;&amp;amp; obj.mchange.left &gt; <span class="number">-0.002</span>)</div><div class="line">    &#123;</div><div class="line">        obj.mchange.left=<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(obj.mchange.up&lt;<span class="number">0.002</span>&amp;amp;&amp;amp; obj.mchange.up &gt; <span class="number">-0.002</span>)</div><div class="line">    &#123;</div><div class="line">        obj.mchange.up=<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//实施移动，未来要考虑把这个实施移动传递给远方客户端</span></div><div class="line">        obj.py0=obj.mesh.position.y;</div><div class="line">        <span class="keyword">var</span> vectir1=(<span class="keyword">new</span> BABYLON.Vector3(<span class="built_in">parseFloat</span>(<span class="built_in">Math</span>.sin(<span class="built_in">parseFloat</span>(obj.mesh.rotation.y))) * obj.mchange.forward * obj.flag_runfast,</div><div class="line">            <span class="number">0</span>, <span class="built_in">parseFloat</span>(<span class="built_in">Math</span>.cos(<span class="built_in">parseFloat</span>(obj.mesh.rotation.y))) * obj.mchange.forward * obj.flag_runfast)).negate();</div><div class="line">        <span class="keyword">var</span> vectir2=<span class="keyword">new</span> BABYLON.Vector3(-<span class="built_in">parseFloat</span>(<span class="built_in">Math</span>.cos(<span class="built_in">parseFloat</span>(obj.mesh.rotation.y))) * obj.mchange.left * obj.flag_runfast,</div><div class="line">            <span class="number">0</span>, <span class="built_in">parseFloat</span>(<span class="built_in">Math</span>.sin(<span class="built_in">parseFloat</span>(obj.mesh.rotation.y))) * obj.mchange.left * obj.flag_runfast).negate();</div><div class="line">        <span class="keyword">var</span> vectir3=<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, obj.mchange.up * obj.flag_runfast, <span class="number">0</span>);</div><div class="line">        obj.vmove = vectir1.add(vectir2).add(vectir3);</div><div class="line"></div><div class="line">        <span class="keyword">if</span>((obj.vmove.x!=<span class="number">0</span>||obj.vmove.y!=<span class="number">0</span>||obj.vmove.z!=<span class="number">0</span>))</div><div class="line">        &#123;</div><div class="line">            obj.mesh.moveWithCollisions(obj.vmove);<span class="comment">//似乎同一时刻只有一个物体能够使用这个方法！！</span></div><div class="line">            </div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>　　这里把物体坐标系位移向世界坐标系位移投影的方法参考了Babylon教程示例。这里有一个思维上的难点：对于一个物体来说“模型的正向”、“mesh的正向”和“骨骼动画的正向”可能不是一个方向！这是模型绘制者使用3D模型绘制工具时的习惯造成的，如果有条件的话可以在使用3D模型前用绘制工具把模型调整一下。</p>
<h2 id="四、数据发送："><a href="#四、数据发送：" class="headerlink" title="四、数据发送："></a>四、数据发送：</h2><h3 id="1、Java后台的Websocket代码："><a href="#1、Java后台的Websocket代码：" class="headerlink" title="1、Java后台的Websocket代码："></a>1、Java后台的Websocket代码：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.Date;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.CopyOnWriteArraySet;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.websocket.OnClose;</div><div class="line"><span class="keyword">import</span> javax.websocket.OnError;</div><div class="line"><span class="keyword">import</span> javax.websocket.OnMessage;</div><div class="line"><span class="keyword">import</span> javax.websocket.OnOpen;</div><div class="line"><span class="keyword">import</span> javax.websocket.Session;</div><div class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</div><div class="line"></div><div class="line"><span class="meta">@ServerEndpoint</span>(<span class="string">"/websocket3"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Practice</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> onlineCount = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CopyOnWriteArraySet&lt;Practice&gt; webSocketSet = <span class="keyword">new</span> CopyOnWriteArraySet&lt;Practice&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String admin=<span class="string">""</span>;</div><div class="line">    <span class="keyword">private</span> Session session;</div><div class="line">    <span class="keyword">private</span> String name=<span class="string">""</span>;</div><div class="line">    <span class="keyword">private</span> String id=<span class="string">""</span>;</div><div class="line">    <span class="meta">@OnOpen</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(Session session)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">this</span>.session = session;</div><div class="line">        webSocketSet.add(<span class="keyword">this</span>);     <span class="comment">//加入set中</span></div><div class="line">        addOnlineCount();           <span class="comment">//在线数加1</span></div><div class="line">        <span class="comment">//System.out.println("有新连接加入！当前在线人数为" + getOnlineCount());</span></div><div class="line">        <span class="keyword">try</span> </div><div class="line">        &#123;</div><div class="line">            <span class="keyword">this</span>.sendMessage(<span class="string">"@id:"</span>+<span class="keyword">this</span>.session.getId());<span class="comment">//这个id是按总连接数来算的，可以避免重复</span></div><div class="line">            <span class="keyword">this</span>.id=<span class="keyword">this</span>.session.getId();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span>(Practice item: webSocketSet)</div><div class="line">        &#123;   </div><div class="line">            <span class="keyword">if</span>(!item.id.equals(<span class="keyword">this</span>.id))</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    item.sendMessage(<span class="string">"[getonl]"</span>+<span class="keyword">this</span>.id);</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@OnClose</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">for</span>(Practice item: webSocketSet)</div><div class="line">        &#123;   </div><div class="line">            <span class="keyword">if</span>(!item.id.equals(<span class="keyword">this</span>.id))</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    item.sendMessage(<span class="string">"[getoff]"</span>+<span class="keyword">this</span>.id);</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.id.equals(Practice.admin))<span class="comment">//如果是admin下线了</span></div><div class="line">        &#123;</div><div class="line">            webSocketSet.remove(<span class="keyword">this</span>);  <span class="comment">//从set中删除</span></div><div class="line">            subOnlineCount();           <span class="comment">//在线数减1</span></div><div class="line">            <span class="keyword">if</span>(webSocketSet.size()&gt;<span class="number">0</span>)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line">                <span class="keyword">for</span>(Practice item: webSocketSet)</div><div class="line">                &#123; <span class="comment">//挑选剩余队列中的下一个玩家作为admin</span></div><div class="line">                    <span class="keyword">if</span>(i==<span class="number">0</span>)</div><div class="line">                    &#123;</div><div class="line">                        i++;</div><div class="line">                        item.name=<span class="string">"admin"</span>;</div><div class="line">                        Practice.admin=item.id;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            item.sendMessage(<span class="string">"@name:admin"</span>);<span class="comment">//任命</span></div><div class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                            e.printStackTrace();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    </div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                Practice.admin=<span class="string">""</span>;<span class="comment">//可能所有用户都下线了，但这个服务还在</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            webSocketSet.remove(<span class="keyword">this</span>);  <span class="comment">//从set中删除</span></div><div class="line">            subOnlineCount();           <span class="comment">//在线数减1</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">//System.out.println("有一连接关闭！当前在线人数为" + getOnlineCount());</span></div><div class="line">    &#125;</div><div class="line">    <span class="meta">@OnMessage</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(String message, Session session)</span> </span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">//System.out.println("来自客户端的消息:" + message);</span></div><div class="line">        <span class="keyword">if</span>((message.length()&gt;<span class="number">6</span>)&amp;amp;&amp;amp;(message.substring(<span class="number">0</span>,<span class="number">6</span>).equals(<span class="string">"@name:"</span>)))<span class="comment">//这个是命名信息//如果message不足6竟然会报错！！</span></div><div class="line">        &#123;</div><div class="line">            String str_name=message.split(<span class="string">":"</span>)[<span class="number">1</span>];    </div><div class="line">            <span class="keyword">if</span>(str_name.equals(<span class="string">"admin"</span>))<span class="comment">//如果这个玩家的角色是admin</span></div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span>(Practice.admin.equals(<span class="string">""</span>))</div><div class="line">                &#123;<span class="comment">//如果还没有admin</span></div><div class="line">                    <span class="keyword">this</span>.name=str_name;</div><div class="line">                    Practice.admin=<span class="keyword">this</span>.id;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="keyword">this</span>.sendMessage(<span class="string">"@name:admin"</span>);<span class="comment">//任命</span></div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                &#123;<span class="comment">//如果已经有了admin</span></div><div class="line">                    <span class="keyword">this</span>.name=<span class="keyword">this</span>.id;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="keyword">this</span>.sendMessage(<span class="string">"@name:"</span>+<span class="keyword">this</span>.session.getId());</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span>((message.length()&gt;<span class="number">6</span>)&amp;amp;&amp;amp;(message.substring(<span class="number">0</span>,<span class="number">7</span>).equals(<span class="string">"privat:"</span>)))</div><div class="line">        &#123;<span class="comment">//私聊信息</span></div><div class="line">            <span class="keyword">for</span>(Practice item: webSocketSet)</div><div class="line">            &#123; </div><div class="line">                <span class="keyword">if</span>(item.id.equals(message.split(<span class="string">"#"</span>)[<span class="number">0</span>].split(<span class="string">":"</span>)[<span class="number">1</span>]))</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        item.sendMessage(<span class="keyword">this</span>.id+<span class="string">"@"</span>+message.split(<span class="string">"#"</span>)[<span class="number">1</span>]);</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;            </div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span>((message.length()&gt;<span class="number">6</span>)&amp;amp;&amp;amp;(message.substring(<span class="number">0</span>,<span class="number">8</span>).equals(<span class="string">"[admins]"</span>))&amp;amp;&amp;amp;<span class="keyword">this</span>.name.equals(<span class="string">"admin"</span>))</div><div class="line">        &#123;<span class="comment">//由adminserver向其他server广播的信息</span></div><div class="line">            <span class="keyword">for</span>(Practice item: webSocketSet)</div><div class="line">            &#123;   </div><div class="line">                <span class="keyword">if</span>(!item.id.equals(<span class="keyword">this</span>.id))</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        item.sendMessage(message);</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;            </div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="comment">//广播信息，不发给自己</span></div><div class="line">            <span class="keyword">for</span>(Practice item: webSocketSet)</div><div class="line">            &#123;   </div><div class="line">                <span class="keyword">if</span>(!item.id.equals(<span class="keyword">this</span>.id))</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        item.sendMessage(<span class="keyword">this</span>.id+<span class="string">"@"</span>+message);</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;               </div><div class="line">    &#125;</div><div class="line">    <span class="meta">@OnError</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Session session, Throwable error)</span></span>&#123;</div><div class="line">        System.out.println(<span class="string">"发生错误，关闭连接"</span>);</div><div class="line">        <span class="keyword">for</span>(Practice item: webSocketSet)</div><div class="line">        &#123;   </div><div class="line">            <span class="keyword">if</span>(!item.id.equals(<span class="keyword">this</span>.id))</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    item.sendMessage(<span class="string">"[geterr]"</span>+<span class="keyword">this</span>.id);</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.id.equals(Practice.admin))<span class="comment">//如果是admin下线了</span></div><div class="line">        &#123;</div><div class="line">            webSocketSet.remove(<span class="keyword">this</span>);  <span class="comment">//从set中删除</span></div><div class="line">            subOnlineCount();           <span class="comment">//在线数减1</span></div><div class="line">            <span class="keyword">if</span>(webSocketSet.size()&gt;<span class="number">0</span>)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line">                <span class="keyword">for</span>(Practice item: webSocketSet)</div><div class="line">                &#123; <span class="comment">//挑选剩余队列中的下一个玩家作为admin</span></div><div class="line">                    <span class="keyword">if</span>(i==<span class="number">0</span>)</div><div class="line">                    &#123;</div><div class="line">                        i++;</div><div class="line">                        item.name=<span class="string">"admin"</span>;</div><div class="line">                        Practice.admin=item.id;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        item.sendMessage(<span class="string">"@name:admin"</span>);<span class="comment">//任命</span></div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                Practice.admin=<span class="string">""</span>;<span class="comment">//可能所有用户都下线了，但这个服务还在</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            webSocketSet.remove(<span class="keyword">this</span>);  <span class="comment">//从set中删除</span></div><div class="line">            subOnlineCount();           <span class="comment">//在线数减1</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">//webSocketSet.remove(this);</span></div><div class="line">        <span class="comment">//subOnlineCount(); </span></div><div class="line">        error.printStackTrace();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(String message)</span> <span class="keyword">throws</span> IOException</span>&#123;<span class="comment">//此为同步阻塞的发送方式（单发）</span></div><div class="line">        <span class="keyword">this</span>.session.getBasicRemote().sendText(message);</div><div class="line">        Date dt=<span class="keyword">new</span> Date();</div><div class="line">        <span class="comment">//System.out.println(dt.getTime()+"==&gt;&gt;"+message);</span></div><div class="line">        <span class="comment">//this.session.getAsyncRemote().sendText(message);</span></div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage2</span><span class="params">(String message)</span> <span class="keyword">throws</span> IOException</span>&#123;<span class="comment">//此为异步非阻塞的发送方式（单发）</span></div><div class="line">        <span class="keyword">this</span>.session.getAsyncRemote ().sendText(message);</div><div class="line">        Date dt=<span class="keyword">new</span> Date();</div><div class="line">        <span class="comment">//System.out.println(dt.getTime()+"==&gt;&gt;"+message);</span></div><div class="line">        <span class="comment">//this.session.getAsyncRemote().sendText(message);</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">getOnlineCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> onlineCount;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addOnlineCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        Practice.onlineCount++;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">subOnlineCount</span><span class="params">()</span> </span>&#123;</div><div class="line">        Practice.onlineCount--;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>　　这个方法参考网上的一篇WebSocket教程编写而成，其大意是为每个上线的用户分配id，并把第一个自称是admin的用户设为主机，在主机用户下线后再任命另一个用户为主机。在数据同步方面提供“私聊”、“admin广播”、“普通广播”三种方式。在传输数据时遇到多个异步传输需求对this.session.getAsyncRemote ()争抢导致报错的问题，经过试验使用同步模式的sendMessage方法可以避免这一错误，至于用户量提升后同步方法能否提供足够的传输效率还要进一步研究。</p>
<h3 id="2、前台的WebSocket代码位于WebSocket-js中："><a href="#2、前台的WebSocket代码位于WebSocket-js中：" class="headerlink" title="2、前台的WebSocket代码位于WebSocket.js中："></a>2、前台的WebSocket代码位于WebSocket.js中：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> wsUri=<span class="string">""</span>;</div><div class="line"><span class="keyword">var</span> websocket;</div><div class="line"><span class="keyword">var</span> id=<span class="string">""</span>;<span class="comment">//这个是sessionid！！</span></div><div class="line"></div><div class="line"><span class="comment">//建立连接</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Connect</span>(<span class="params"></span>)</span></div><div class="line">&#123;<span class="comment">//</span></div><div class="line">    <span class="keyword">var</span> location = (<span class="built_in">window</span>.location+<span class="string">''</span>).split(<span class="string">'/'</span>);</div><div class="line">    <span class="keyword">var</span> IP=location[<span class="number">2</span>];</div><div class="line">    <span class="comment">//wsUri="ws://"+IP+"/JUMP/websocket3";</span></div><div class="line">    wsUri=<span class="string">"ws://"</span>+$(<span class="string">"#str_ip"</span>)[<span class="number">0</span>].value+<span class="string">":8081/PRACTICE/websocket3"</span>;</div><div class="line">    <span class="keyword">try</span></div><div class="line">    &#123;</div><div class="line">        websocket = <span class="keyword">new</span> WebSocket(wsUri);<span class="comment">//建立ws连接</span></div><div class="line">        $(<span class="string">"#str_ip"</span>)[<span class="number">0</span>].disabled=<span class="literal">true</span>;</div><div class="line">        $(<span class="string">"#str_name"</span>)[<span class="number">0</span>].disabled=<span class="literal">true</span>;</div><div class="line">        username=$(<span class="string">"#str_name"</span>)[<span class="number">0</span>].value;</div><div class="line">        $(<span class="string">"#btn_create"</span>)[<span class="number">0</span>].disabled=<span class="literal">false</span>;</div><div class="line"></div><div class="line">        websocket.onopen = <span class="function"><span class="keyword">function</span>(<span class="params">evt</span>) //连接建立完毕</span></div><div class="line">        &#123;</div><div class="line">            onOpen(evt)</div><div class="line">        &#125;;</div><div class="line">        websocket.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">evt</span>) </span>&#123;<span class="comment">//收到服务器发来的信息</span></div><div class="line">            onMessage(evt)</div><div class="line">        &#125;;</div><div class="line">        websocket.onclose = <span class="function"><span class="keyword">function</span>(<span class="params">evt</span>) </span>&#123;</div><div class="line">            onClose(evt)</div><div class="line">        &#125;;</div><div class="line">        websocket.onerror = <span class="function"><span class="keyword">function</span>(<span class="params">evt</span>) </span>&#123;</div><div class="line">            onError(evt)</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span>(e)</div><div class="line">    &#123;</div><div class="line">        alert(e);</div><div class="line">        $(<span class="string">"#str_ip"</span>)[<span class="number">0</span>].disabled=<span class="literal">false</span>;</div><div class="line">        $(<span class="string">"#str_name"</span>)[<span class="number">0</span>].disabled=<span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//连接建立完成的回调函数</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onOpen</span>(<span class="params">evt</span>) </span>&#123;</div><div class="line">    state=<span class="string">"online"</span>;</div><div class="line">    doSend(<span class="string">"@name:"</span>+$(<span class="string">"#str_name"</span>)[<span class="number">0</span>].value);<span class="comment">//连接建立后把浏览器端的用户信息传过去</span></div><div class="line">&#125;</div><div class="line"><span class="comment">//关闭连接</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Close</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    websocket.close();<span class="comment">//浏览器端关闭连接</span></div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onClose</span>(<span class="params">evt</span>) </span>&#123;</div><div class="line">    writeToScreen(<span class="string">'&lt;span style="color: red;"&gt;本机连接关闭&lt;/span&gt;'</span>);</div><div class="line">    $(<span class="string">"#str_ip"</span>)[<span class="number">0</span>].disabled=<span class="literal">false</span>;</div><div class="line">    $(<span class="string">"#str_name"</span>)[<span class="number">0</span>].disabled=<span class="literal">false</span>;</div><div class="line">    state=<span class="string">"offline"</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">//收到服务器端发来的消息</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onMessage</span>(<span class="params">evt</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> str_data=evt.data;</div><div class="line">    <span class="keyword">if</span>(str_data.substr(<span class="number">0</span>,<span class="number">4</span>)==<span class="string">"@id:"</span>)<span class="comment">//从服务端返回了sessionid</span></div><div class="line">    &#123;</div><div class="line">        id=str_data.split(<span class="string">":"</span>)[<span class="number">1</span>];</div><div class="line">        $(<span class="string">"#str_id"</span>)[<span class="number">0</span>].innerHTML=id;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str_data.substr(<span class="number">0</span>,<span class="number">6</span>)==<span class="string">"@name:"</span>)<span class="comment">//从服务端返回了任命信息</span></div><div class="line">    &#123;</div><div class="line">        username=str_data.split(<span class="string">":"</span>)[<span class="number">1</span>];</div><div class="line">        <span class="keyword">if</span>(username==<span class="string">"admin"</span>)</div><div class="line">        &#123;</div><div class="line">            $(<span class="string">"#str_name"</span>)[<span class="number">0</span>].value=username;</div><div class="line">            writeToScreen(<span class="string">'&lt;span style="color: blue;"&gt;本机被任命为admin&lt;/span&gt;'</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            $(<span class="string">"#str_name"</span>)[<span class="number">0</span>].value=username;</div><div class="line">            writeToScreen(<span class="string">'&lt;span style="color: blue;"&gt;已存在admin，本机被重命名为'</span>+username+<span class="string">'&lt;/span&gt;'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">。。。</div><div class="line">    </div><div class="line"><span class="comment">//发生错误</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onError</span>(<span class="params">evt</span>) </span>&#123;</div><div class="line">    writeToScreen(<span class="string">'&lt;span style="color: red;"&gt;ERROR:&lt;/span&gt; '</span>+ evt.data);</div><div class="line">    $(<span class="string">"#str_ip"</span>)[<span class="number">0</span>].disabled=<span class="literal">false</span>;</div><div class="line">    $(<span class="string">"#str_name"</span>)[<span class="number">0</span>].disabled=<span class="literal">false</span>;</div><div class="line">    state=<span class="string">"offline"</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">//发送命令行信息</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Send</span>(<span class="params"></span>)</span></div><div class="line">&#123;</div><div class="line">    doSend($(<span class="string">"#str_message"</span>)[<span class="number">0</span>].value);</div><div class="line">&#125;</div><div class="line"><span class="comment">//向服务端发送信息</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSend</span>(<span class="params">message</span>)</span></div><div class="line">&#123;</div><div class="line">    websocket.send(message);</div><div class="line">&#125;</div><div class="line"><span class="comment">//写入操作日志</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeToScreen</span>(<span class="params">message</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> pre = <span class="built_in">document</span>.createElement(<span class="string">"p"</span>);</div><div class="line">    pre.style.wordWrap = <span class="string">"break-word"</span>;</div><div class="line">    pre.innerHTML = MakeDateStr()+<span class="string">"-&gt;"</span>+message;</div><div class="line">    str_log.appendChild(pre);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>　　参考网上教程编写的常规WebSocket通信代码</p>
<h3 id="3、建立一些“NPC物体”，也要对他们的状态进行同步"><a href="#3、建立一些“NPC物体”，也要对他们的状态进行同步" class="headerlink" title="3、建立一些“NPC物体”，也要对他们的状态进行同步"></a>3、建立一些“NPC物体”，也要对他们的状态进行同步</h3><p>NPC物体的建立代码在scene_link.js文件的110行：<br><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="picture"><br><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="picture"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//一次引入十个物体</span></div><div class="line">    BABYLON.SceneLoader.ImportMesh(<span class="string">"Rabbit"</span>, <span class="string">"../MODEL/Rabbit/"</span>, <span class="string">"Rabbit.babylon"</span>, scene, <span class="function"><span class="keyword">function</span> (<span class="params">newMeshes, particleSystems, skeletons</span>)</span></div><div class="line">    &#123;</div><div class="line"></div><div class="line">        <span class="keyword">var</span> rabbitmesh = newMeshes[<span class="number">1</span>];</div><div class="line">        <span class="comment">//shadowGenerator.getShadowMap().renderList.push(rabbitmesh);//加入阴影渲染队列</span></div><div class="line">        <span class="keyword">var</span> rabbit=<span class="keyword">new</span> Animal;</div><div class="line">        <span class="keyword">var</span> obj_p=&#123;</div><div class="line">            mesh:rabbitmesh,</div><div class="line">            scaling:<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0.04</span>, <span class="number">0.04</span>, <span class="number">0.04</span>),<span class="comment">//缩放</span></div><div class="line">            position:<span class="keyword">new</span> BABYLON.Vector3(<span class="built_in">Math</span>.random()*<span class="number">100</span>, <span class="number">30</span>, <span class="built_in">Math</span>.random()*<span class="number">100</span>),<span class="comment">//位置</span></div><div class="line">            rotation:<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="built_in">Math</span>.random()*<span class="number">6.28</span>, <span class="number">0</span>),<span class="comment">// 旋转</span></div><div class="line">            <span class="comment">//rotation:new BABYLON.Vector3(0, 0, 0),</span></div><div class="line">            checkCollisions:<span class="literal">true</span>,<span class="comment">//使用默认的碰撞检测</span></div><div class="line">            ellipsoid:<span class="keyword">new</span> BABYLON.Vector3(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>),<span class="comment">//碰撞检测椭球</span></div><div class="line">            ellipsoidOffset:<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>),<span class="comment">//碰撞检测椭球位移</span></div><div class="line">            fieldofvision:<span class="number">50</span>,<span class="comment">//视野</span></div><div class="line">            powerofmove:<span class="number">1</span>,<span class="comment">//移动力量</span></div><div class="line">            methodofmove:<span class="string">"controlwitha"</span>,</div><div class="line">            state:<span class="string">"eat"</span>,</div><div class="line">            id:<span class="string">"rabbit"</span></div><div class="line">        &#125;;</div><div class="line">        rabbit.init(obj_p);</div><div class="line">        arr_animals[<span class="string">"rabbit"</span>]=rabbit;</div><div class="line">        scene.beginAnimation(rabbitmesh.skeleton, <span class="number">0</span>, <span class="number">72</span>, <span class="literal">true</span>, <span class="number">0.8</span>);</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">"rabbit"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">9</span>;i++)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> rabbitmesh2 = rabbitmesh.clone(<span class="string">"rabbit2"</span>+(i+<span class="number">2</span>));</div><div class="line">            rabbitmesh2.skeleton = rabbitmesh.skeleton.clone(<span class="string">"clonedSkeleton"</span>);</div><div class="line">            <span class="keyword">var</span> rabbit2=<span class="keyword">new</span> Animal;</div><div class="line">            <span class="keyword">var</span> obj_p2=&#123;</div><div class="line">                mesh:rabbitmesh2,</div><div class="line">                scaling:<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0.04</span>, <span class="number">0.04</span>, <span class="number">0.04</span>),<span class="comment">//缩放</span></div><div class="line">                position:<span class="keyword">new</span> BABYLON.Vector3(<span class="built_in">Math</span>.random()*<span class="number">100</span>, <span class="number">30</span>, <span class="built_in">Math</span>.random()*<span class="number">100</span>),<span class="comment">//位置</span></div><div class="line">                rotation:<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="built_in">Math</span>.random()*<span class="number">6.28</span>, <span class="number">0</span>),<span class="comment">// 旋转</span></div><div class="line">                <span class="comment">//rotation:new BABYLON.Vector3(0, 0, 0),// 旋转</span></div><div class="line">                checkCollisions:<span class="literal">true</span>,<span class="comment">//使用默认的碰撞检测</span></div><div class="line">                ellipsoid:<span class="keyword">new</span> BABYLON.Vector3(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>),<span class="comment">//碰撞检测椭球</span></div><div class="line">                ellipsoidOffset:<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>),<span class="comment">//碰撞检测椭球位移</span></div><div class="line">                fieldofvision:<span class="number">50</span>,<span class="comment">//视野</span></div><div class="line">                powerofmove:<span class="number">1</span>,<span class="comment">//移动力量</span></div><div class="line">                methodofmove:<span class="string">"controlwitha"</span>,</div><div class="line">                state:<span class="string">"eat"</span>,</div><div class="line">                id:<span class="string">"rabbit"</span>+(i+<span class="number">2</span>)</div><div class="line">            &#125;;</div><div class="line">            rabbit2.init(obj_p2);</div><div class="line">            arr_animals[<span class="string">"rabbit"</span>+(i+<span class="number">2</span>)]=rabbit2;</div><div class="line">            scene.beginAnimation(rabbitmesh2.skeleton, <span class="number">0</span>, <span class="number">72</span>, <span class="literal">true</span>, <span class="number">0.8</span>);</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">"rabbit"</span>+(i+<span class="number">2</span>));</div><div class="line">            <span class="comment">//shadowGenerator.getShadowMap().renderList.push(rabbitmesh2);//报错</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>View Code　　这里建立了十个物体，其中只有第一个物体的骨骼模型是从模型文件中导入内存的，其他的物体都在内存中从第一个物体“克隆”而来。注意，在Babylon看来骨骼也是一种特殊的网格（Mesh），所以对网格和骨骼的克隆是分别进行的，再把骨骼克隆的结果作为网格克隆结果的骨骼属性。<br>　　十个物体被初始化为Animal对象，Animal对象与Player对象类似，都是从sdyq.object对象派生而来。<br>NPC物体的运动控制和运动同步代码在317行：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(username==<span class="string">"admin"</span>)<span class="comment">//由主机对所有NPC物体的相互作用进行计算，再把作用结果同步到各个分机</span></div><div class="line">                &#123;</div><div class="line">                    <span class="comment">//计算每个动物和所有玩家的交互效果</span></div><div class="line">                    <span class="keyword">var</span> arr_rabbitmove=[];</div><div class="line">                    <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> arr_animals)</div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">var</span> rabbit=arr_animals[key];</div><div class="line">                        <span class="keyword">var</span> v_face=<span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</div><div class="line">                        <span class="keyword">var</span> newstate=<span class="string">"eat"</span>;</div><div class="line">                        <span class="keyword">for</span>(<span class="keyword">var</span> key2 <span class="keyword">in</span> arr_myplayers)</div><div class="line">                        &#123;</div><div class="line">                            <span class="keyword">var</span> obj=arr_myplayers[key2];</div><div class="line">                            <span class="keyword">var</span> v_sub=rabbit.mesh.position.subtract(obj.mesh.position);</div><div class="line">                            <span class="keyword">var</span> distans=v_sub.length();<span class="comment">//兔子与人类之间的距离</span></div><div class="line">                            <span class="keyword">if</span>(distans&lt;rabbit.fieldofvision)<span class="comment">//在视野内发现了人类</span></div><div class="line">                            &#123;</div><div class="line">                                newstate=<span class="string">"run"</span>;</div><div class="line">                                v_face.addInPlace(v_sub.normalize().scaleInPlace(<span class="number">1</span>/distans));<span class="comment">//越近则影响越大</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">for</span>(<span class="keyword">var</span> key2 <span class="keyword">in</span> arr_webplayers)</div><div class="line">                        &#123;</div><div class="line">                            <span class="keyword">var</span> obj=arr_webplayers[key2];</div><div class="line">                            <span class="keyword">var</span> v_sub=rabbit.mesh.position.subtract(obj.mesh.position);</div><div class="line">                            <span class="keyword">var</span> distans=v_sub.length();</div><div class="line">                            <span class="keyword">if</span>(distans&lt;rabbit.fieldofvision)<span class="comment">//在视野内发现了人类</span></div><div class="line">                            &#123;</div><div class="line">                                newstate=<span class="string">"run"</span>;</div><div class="line">                                v_face.addInPlace(v_sub.normalize().scaleInPlace(<span class="number">1</span>/distans));</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span>(newstate==<span class="string">"run"</span>&amp;amp;&amp;amp;rabbit.state==<span class="string">"eat"</span>)</div><div class="line">                        &#123;<span class="comment">//从eat状态变为run状态</span></div><div class="line">                            rabbit.state=<span class="string">"run"</span>;</div><div class="line">                            rabbit.powerofmove=<span class="number">3</span>;</div><div class="line">                            scene.beginAnimation(rabbit.mesh.skeleton, <span class="number">0</span>, <span class="number">72</span>, <span class="literal">true</span>, <span class="number">2.4</span>);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">else</span> <span class="keyword">if</span>(newstate==<span class="string">"eat"</span>&amp;amp;&amp;amp;rabbit.state==<span class="string">"run"</span>)</div><div class="line">                        &#123;<span class="comment">//从run状态变为eat状态</span></div><div class="line">                            rabbit.state=<span class="string">"eat"</span>;</div><div class="line">                            rabbit.powerofmove=<span class="number">1</span>;</div><div class="line">                            scene.beginAnimation(rabbit.mesh.skeleton, <span class="number">0</span>, <span class="number">72</span>, <span class="literal">true</span>, <span class="number">0.8</span>);</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="keyword">var</span> num_pi=<span class="built_in">Math</span>.PI;</div><div class="line">                        <span class="keyword">if</span>(rabbit.state==<span class="string">"eat"</span>)<span class="comment">//一直没有见到人类</span></div><div class="line">                        &#123;</div><div class="line">                            rabbit.waitforturn+=schange;</div><div class="line">                            <span class="keyword">if</span>(rabbit.waitforturn&gt;<span class="number">3</span>)</div><div class="line">                            &#123;<span class="comment">//每3秒随机决定一个运动方向</span></div><div class="line">                                rabbit.waitforturn=<span class="number">0</span>;</div><div class="line">                                rabbit.witha0=&#123;forward:(<span class="built_in">Math</span>.random()<span class="number">-0.5</span>)*<span class="number">2</span>*rabbit.powerofmove,up:<span class="number">0</span>,left:(<span class="built_in">Math</span>.random()<span class="number">-0.5</span>)*<span class="number">2</span>*rabbit.powerofmove&#125;;</div><div class="line">                                rabbit.mesh.rotation.y=<span class="built_in">Math</span>.random()*<span class="number">6.28</span>;</div><div class="line">                            &#125;</div><div class="line">                            movewitha(rabbit);</div><div class="line">                            <span class="comment">//这些兔子的数据汇总起来一起传</span></div><div class="line">                            arr_rabbitmove.push([key,rabbit.mesh.position,rabbit.mesh.rotation,rabbit.vmove,rabbit.rychange,rabbit.state]);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">else</span> <span class="keyword">if</span>(rabbit.state==<span class="string">"run"</span>)</div><div class="line">                        &#123;<span class="comment">//奔跑远离人类</span></div><div class="line">                            rabbit.witha0=&#123;forward:-rabbit.powerofmove,up:<span class="number">0</span>,left:<span class="number">0</span>&#125;;<span class="comment">//这个是兔子的“自主加速度”！！不是世界加速度，也不是键盘控制产生的加速度</span></div><div class="line">                            rabbit.mesh.rotation.y=(<span class="built_in">Math</span>.atan(v_face.z/v_face.x)+num_pi*<span class="number">1</span>/<span class="number">2</span>);</div><div class="line">                            movewitha(rabbit);</div><div class="line">                            arr_rabbitmove.push([key,rabbit.mesh.position,rabbit.mesh.rotation,rabbit.vmove,rabbit.rychange,rabbit.state]);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">var</span> str_data=<span class="string">"[admins]"</span>+<span class="built_in">JSON</span>.stringify(arr_rabbitmove);</div><div class="line">                    doSend(str_data);</div><div class="line">                &#125;</div></pre></td></tr></table></figure></p>
<p>　　在这个模式中，由主机承担所有的NPC物体运动计算工作，再把所有计算结果同步到分机，&nbsp;<br>　　起初对于不太复杂的玩家信息数据，我简单的用分隔符“@”将各个字段拼接成一个字符串向其他客户端传递，后来随着数据结构的复杂化，我改用JSON传递结构化的数据。</p>
<h3 id="4、客户端对服务器端传来的信息进行处理："><a href="#4、客户端对服务器端传来的信息进行处理：" class="headerlink" title="4、客户端对服务器端传来的信息进行处理："></a>4、客户端对服务器端传来的信息进行处理：</h3><h4 id="a、添加新玩家，代码位于WebSocket-js184行："><a href="#a、添加新玩家，代码位于WebSocket-js184行：" class="headerlink" title="a、添加新玩家，代码位于WebSocket.js184行："></a>a、添加新玩家，代码位于WebSocket.js184行：</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">"addnewplayer"</span>:</div><div class="line">                    &#123;<span class="comment">//感知到加入了一个新的玩家，把新玩家加入到自己的场景里,先查询场景中是否已经有同名的mesh，如果有则使用clone方法同步加载，如果没有再使用import异步导入，这样做的根本原因在于import方法导入模型的返回函数里无法自定义参数</span></div><div class="line">                        <span class="keyword">var</span> dt=<span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">                        <span class="built_in">console</span>.log(dt.getTime()+<span class="string">"get addnewplayer"</span>+arr[<span class="number">0</span>]);</div><div class="line">                        <span class="keyword">var</span> flag=<span class="number">0</span>;<span class="comment">//加载完成标志</span></div><div class="line">                        <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> arr_myplayers)<span class="comment">//先在本机的玩家列表里找</span></div><div class="line">                        &#123;</div><div class="line">                            <span class="keyword">if</span>(arr_myplayers[key].meshname==arr[<span class="number">14</span>])<span class="comment">//如果与主控物体的meshname相同</span></div><div class="line">                            &#123;</div><div class="line"></div><div class="line">                                <span class="keyword">var</span> obj_key=arr_myplayers[key];</div><div class="line">                                arr_webplayers[arr[<span class="number">0</span>]] = MyCloneplayer(obj_key,arr);</div><div class="line">                                shadowGenerator.getShadowMap().renderList.push(arr_webplayers[arr[<span class="number">0</span>]].mesh);<span class="comment">//阴影生成器似乎对含有submesh的Mesh不起作用</span></div><div class="line">                                writeToScreen(<span class="string">'&lt;span style="color: blue;"&gt;addnewplayer: '</span> + arr[<span class="number">0</span>] + <span class="string">'&lt;/span&gt;'</span>);</div><div class="line">                                flag=<span class="number">1</span>;</div><div class="line"></div><div class="line">                                <span class="comment">//异步加入新玩家之后，还要把自己的信息发给新玩家，让新玩家添加自己（私聊）</span></div><div class="line">                                addoldplayer(arr[<span class="number">0</span>]);</div><div class="line">                                <span class="keyword">break</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span>(flag==<span class="number">0</span>)<span class="comment">//再在网络玩家列表里查找</span></div><div class="line">                        &#123;</div><div class="line">                            <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> arr_webplayers)</div><div class="line">                            &#123;</div><div class="line">                                <span class="keyword">if</span>(arr_webplayers[key].meshname==arr[<span class="number">14</span>])<span class="comment">//如果与主控物体的meshname相同</span></div><div class="line">                                &#123;</div><div class="line">                                    <span class="keyword">var</span> obj_key=arr_webplayers[key];</div><div class="line">                                    arr_webplayers[arr[<span class="number">0</span>]] = MyCloneplayer(obj_key,arr);</div><div class="line">                                    shadowGenerator.getShadowMap().renderList.push(arr_webplayers[arr[<span class="number">0</span>]].mesh);</div><div class="line">                                    writeToScreen(<span class="string">'&lt;span style="color: blue;"&gt;addnewplayer: '</span> + arr[<span class="number">0</span>] + <span class="string">'&lt;/span&gt;'</span>);</div><div class="line">                                    flag=<span class="number">1</span>;</div><div class="line">                                    <span class="comment">//异步加入新玩家之后，还要把自己的信息发给新玩家，让新玩家添加自己（私聊）</span></div><div class="line">                                    addoldplayer(arr[<span class="number">0</span>]);</div><div class="line">                                    <span class="keyword">break</span>;</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span>(flag==<span class="number">0</span>)<span class="comment">//都没找着，就新建</span></div><div class="line">                        &#123;</div><div class="line">                            <span class="comment">//arr[14]保存着meshname可以作为异步方法间的纽带,如果发生同时加载两个一样的不存在的mesh时，让后来的那个通过websocket延时重发</span></div><div class="line">                            <span class="keyword">if</span>(tempobj[arr[<span class="number">14</span>]]&amp;amp;&amp;amp;tempobj[arr[<span class="number">14</span>]]!=<span class="string">"OK"</span>)<span class="comment">//这个暂存位正在被占用</span></div><div class="line">                            &#123;</div><div class="line">                                doSend(<span class="string">"privat:"</span> + id + <span class="string">"#"</span> + str_data);<span class="comment">//请求websocket服务器再次把这个指令发给自己，以等待占用者完成操作</span></div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">else</span></div><div class="line">                            &#123;</div><div class="line">                                tempobj[arr[<span class="number">14</span>]] = arr;<span class="comment">//用tempobj暂存该物体的初始化参数</span></div><div class="line">                                BABYLON.SceneLoader.ImportMesh(arr[<span class="number">11</span>], arr[<span class="number">12</span>], arr[<span class="number">13</span>], scene, <span class="function"><span class="keyword">function</span> (<span class="params">newMeshes, particleSystems, skeletons</span>) </span>&#123;<span class="comment">//载入完成的回调函数</span></div><div class="line">                                    <span class="keyword">var</span> Tom = <span class="keyword">new</span> Player;</div><div class="line">                                    <span class="keyword">var</span> obj_p = &#123;&#125;;</div><div class="line">                                    obj_p.mesh = newMeshes[<span class="number">0</span>];<span class="comment">//网格数据</span></div><div class="line">                                    <span class="keyword">var</span> arr = tempobj[obj_p.mesh.name];</div><div class="line">                                    obj_p.scaling = <span class="keyword">new</span> BABYLON.Vector3(<span class="built_in">parseFloat</span>(arr[<span class="number">2</span>]), <span class="built_in">parseFloat</span>(arr[<span class="number">3</span>]), <span class="built_in">parseFloat</span>(arr[<span class="number">4</span>]));<span class="comment">//缩放</span></div><div class="line">                                    obj_p.position = <span class="keyword">new</span> BABYLON.Vector3(<span class="built_in">parseFloat</span>(arr[<span class="number">5</span>]), <span class="built_in">parseFloat</span>(arr[<span class="number">6</span>]), <span class="built_in">parseFloat</span>(arr[<span class="number">7</span>]));<span class="comment">//位置</span></div><div class="line">                                    obj_p.rotation = <span class="keyword">new</span> BABYLON.Vector3(<span class="built_in">parseFloat</span>(arr[<span class="number">8</span>]), <span class="built_in">parseFloat</span>(arr[<span class="number">9</span>]), <span class="built_in">parseFloat</span>(arr[<span class="number">10</span>]));<span class="comment">// 旋转</span></div><div class="line">                                    obj_p.checkCollisions = <span class="literal">true</span>;<span class="comment">//使用默认的碰撞检测</span></div><div class="line">                                    obj_p.ellipsoid = <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0.5</span>, <span class="number">1</span>, <span class="number">0.5</span>);<span class="comment">//碰撞检测椭球</span></div><div class="line">                                    obj_p.ellipsoidOffset = <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);<span class="comment">//碰撞检测椭球位移</span></div><div class="line">                                    obj_p.skeletonsPlayer = skeletons;</div><div class="line">                                    obj_p.methodofmove = <span class="string">"controlwitha"</span>;</div><div class="line">                                    obj_p.id = arr[<span class="number">0</span>];</div><div class="line">                                    obj_p.name = arr[<span class="number">0</span>];</div><div class="line">                                    obj_p.p1 = arr[<span class="number">11</span>];</div><div class="line">                                    obj_p.p2 = arr[<span class="number">12</span>];</div><div class="line">                                    obj_p.p3 = arr[<span class="number">13</span>];</div><div class="line">                                    <span class="keyword">var</span> len=newMeshes.length;<span class="comment">//对于复杂的模型来说newMeshes的其他部分也必须保存下来</span></div><div class="line">                                    <span class="keyword">var</span> arr=[];</div><div class="line">                                    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">1</span>;i&lt;len;i++)</div><div class="line">                                    &#123;</div><div class="line">                                        arr.push(newMeshes[i]);</div><div class="line">                                    &#125;</div><div class="line">                                    obj_p.submeshs=arr;</div><div class="line">                                    Tom.init(</div><div class="line">                                        obj_p</div><div class="line">                                    );</div><div class="line">                                    tempobj[obj_p.mesh.name] = <span class="string">"OK"</span>;</div><div class="line">                                    arr_webplayers[arr[<span class="number">0</span>]] = Tom;</div><div class="line">                                    shadowGenerator.getShadowMap().renderList.push(arr_webplayers[arr[<span class="number">0</span>]].mesh);</div><div class="line"></div><div class="line">                                    writeToScreen(<span class="string">'&lt;span style="color: blue;"&gt;addnewplayer: '</span> + arr[<span class="number">0</span>] + <span class="string">'&lt;/span&gt;'</span>);</div><div class="line">                                    flag=<span class="number">1</span>;</div><div class="line">                                    <span class="comment">//异步加入新玩家之后，还要把自己的信息发给新玩家，让新玩家添加自己（私聊）</span></div><div class="line">                                    addoldplayer(arr[<span class="number">0</span>]);</div><div class="line"></div><div class="line">                                &#125;);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">case</span> <span class="string">"addoldplayer"</span>:</div><div class="line">                    &#123;<span class="comment">//添加一个前辈玩家，此时默认前辈的网络玩家列表里已经有了本元素，所以不需要再通知前辈玩家添加本玩家，多个前辈玩家同时返回如何处理？用出入栈方式？能保证先进先出？</span></div><div class="line">                         <span class="keyword">var</span> dt=<span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">                         <span class="built_in">console</span>.log(dt.getTime()+<span class="string">"get addoldplayer"</span>+arr[<span class="number">0</span>]);</div><div class="line">                         <span class="keyword">var</span> flag=<span class="number">0</span>;</div><div class="line">                         <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> arr_myplayers)</div><div class="line">                         &#123;</div><div class="line">                             <span class="keyword">if</span>(arr_myplayers[key].meshname==arr[<span class="number">14</span>])<span class="comment">//如果与主控物体的meshname相同</span></div><div class="line">                             &#123;</div><div class="line">                                 <span class="keyword">var</span> obj_key=arr_myplayers[key];</div><div class="line">                                 arr_webplayers[arr[<span class="number">0</span>]] =MyCloneplayer(obj_key,arr);</div><div class="line">                                 shadowGenerator.getShadowMap().renderList.push(arr_webplayers[arr[<span class="number">0</span>]].mesh);</div><div class="line">                                 writeToScreen(<span class="string">'&lt;span style="color: blue;"&gt;addoldplayer: '</span> + arr[<span class="number">0</span>] + <span class="string">'&lt;/span&gt;'</span>);</div><div class="line">                                 flag=<span class="number">1</span>;</div><div class="line"> </div><div class="line">                                 <span class="keyword">break</span>;</div><div class="line">                             &#125;</div><div class="line">                         &#125;</div><div class="line">                         <span class="keyword">if</span>(flag==<span class="number">0</span>)<span class="comment">//再在网络元素里查找</span></div><div class="line">                         &#123;</div><div class="line">                             <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> arr_webplayers)</div><div class="line">                             &#123;</div><div class="line">                                 <span class="keyword">if</span>(arr_webplayers[key].meshname==arr[<span class="number">14</span>])<span class="comment">//如果与主控物体的meshname相同</span></div><div class="line">                                 &#123;</div><div class="line">                                     <span class="keyword">var</span> obj_key=arr_webplayers[key];</div><div class="line">                                     arr_webplayers[arr[<span class="number">0</span>]] =  MyCloneplayer(obj_key,arr);</div><div class="line">                                     shadowGenerator.getShadowMap().renderList.push(arr_webplayers[arr[<span class="number">0</span>]].mesh);</div><div class="line">                                     writeToScreen(<span class="string">'&lt;span style="color: blue;"&gt;addoldplayer: '</span> + arr[<span class="number">0</span>] + <span class="string">'&lt;/span&gt;'</span>);</div><div class="line">                                     flag=<span class="number">1</span>;</div><div class="line">                                     <span class="keyword">break</span>;</div><div class="line">                                 &#125;</div><div class="line">                             &#125;</div><div class="line">                         &#125;</div><div class="line">                         <span class="keyword">if</span>(flag==<span class="number">0</span>)<span class="comment">//都没找着，就新建</span></div><div class="line">                         &#123;</div><div class="line">                             <span class="comment">//arr[14]保存着meshname可以作为异步方法间的纽带,如果发生同时加载两个一样的不存在的mesh时，让后来的那个通过websocket延时重发</span></div><div class="line">                             <span class="keyword">if</span>(tempobj[arr[<span class="number">14</span>]]&amp;amp;&amp;amp;tempobj[arr[<span class="number">14</span>]]!=<span class="string">"OK"</span>)<span class="comment">//这个暂存位正在被占用</span></div><div class="line">                             &#123;</div><div class="line">                                 doSend(<span class="string">"privat:"</span> + id + <span class="string">"#"</span> + str_data);<span class="comment">//请求websocket服务器再次把这个指令发给自己，以等待占用者完成操作</span></div><div class="line">                             &#125;</div><div class="line">                             <span class="keyword">else</span></div><div class="line">                             &#123;</div><div class="line">                                 tempobj[arr[<span class="number">14</span>]] = arr;</div><div class="line">                                 BABYLON.SceneLoader.ImportMesh(arr[<span class="number">11</span>], arr[<span class="number">12</span>], arr[<span class="number">13</span>], scene, <span class="function"><span class="keyword">function</span> (<span class="params">newMeshes, particleSystems, skeletons</span>) </span>&#123;<span class="comment">//载入完成的回调函数</span></div><div class="line">                                     <span class="keyword">var</span> Tom = <span class="keyword">new</span> Player;</div><div class="line">                                     <span class="keyword">var</span> obj_p = &#123;&#125;;</div><div class="line">                                     obj_p.mesh = newMeshes[<span class="number">0</span>];<span class="comment">//网格数据</span></div><div class="line">                                     <span class="keyword">var</span> arr = tempobj[obj_p.mesh.name];</div><div class="line">                                     obj_p.scaling = <span class="keyword">new</span> BABYLON.Vector3(<span class="built_in">parseFloat</span>(arr[<span class="number">2</span>]), <span class="built_in">parseFloat</span>(arr[<span class="number">3</span>]), <span class="built_in">parseFloat</span>(arr[<span class="number">4</span>]));<span class="comment">//缩放</span></div><div class="line">                                     obj_p.position = <span class="keyword">new</span> BABYLON.Vector3(<span class="built_in">parseFloat</span>(arr[<span class="number">5</span>]), <span class="built_in">parseFloat</span>(arr[<span class="number">6</span>]), <span class="built_in">parseFloat</span>(arr[<span class="number">7</span>]));<span class="comment">//位置</span></div><div class="line">                                     obj_p.rotation = <span class="keyword">new</span> BABYLON.Vector3(<span class="built_in">parseFloat</span>(arr[<span class="number">8</span>]), <span class="built_in">parseFloat</span>(arr[<span class="number">9</span>]), <span class="built_in">parseFloat</span>(arr[<span class="number">10</span>]));<span class="comment">// 旋转</span></div><div class="line">                                     obj_p.checkCollisions = <span class="literal">true</span>;<span class="comment">//使用默认的碰撞检测</span></div><div class="line">                                     obj_p.ellipsoid = <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0.5</span>, <span class="number">1</span>, <span class="number">0.5</span>);<span class="comment">//碰撞检测椭球</span></div><div class="line">                                     obj_p.ellipsoidOffset = <span class="keyword">new</span> BABYLON.Vector3(<span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);<span class="comment">//碰撞检测椭球位移</span></div><div class="line">                                     obj_p.skeletonsPlayer = skeletons;</div><div class="line">                                     obj_p.methodofmove = <span class="string">"controlwitha"</span>;</div><div class="line">                                     obj_p.id = arr[<span class="number">0</span>];</div><div class="line">                                     obj_p.name = arr[<span class="number">0</span>];</div><div class="line">                                     obj_p.p1 = arr[<span class="number">11</span>];</div><div class="line">                                     obj_p.p2 = arr[<span class="number">12</span>];</div><div class="line">                                     obj_p.p3 = arr[<span class="number">13</span>];</div><div class="line">                                     <span class="keyword">var</span> len=newMeshes.length;<span class="comment">//对于复杂的模型来说newMeshes的其他部分也必须保存下来</span></div><div class="line">                                     <span class="keyword">var</span> arr=[];</div><div class="line">                                     <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">1</span>;i&lt;len;i++)</div><div class="line">                                     &#123;</div><div class="line">                                         arr.push(newMeshes[i]);</div><div class="line">                                     &#125;</div><div class="line">                                     obj_p.submeshs=arr;</div><div class="line">                                     Tom.init(</div><div class="line">                                         obj_p</div><div class="line">                                     );</div><div class="line">                                     tempobj[obj_p.mesh.name] = <span class="string">"OK"</span>;</div><div class="line">                                     arr_webplayers[arr[<span class="number">0</span>]] = Tom;</div><div class="line">                                     shadowGenerator.getShadowMap().renderList.push(arr_webplayers[arr[<span class="number">0</span>]].mesh);</div><div class="line">                                     writeToScreen(<span class="string">'&lt;span style="color: blue;"&gt;addoldplayer: '</span> + arr[<span class="number">0</span>] + <span class="string">'&lt;/span&gt;'</span>);</div><div class="line">                                     flag=<span class="number">1</span>;</div><div class="line"> </div><div class="line">                                 &#125;);</div><div class="line">                             &#125;</div><div class="line">                         &#125;</div><div class="line">                         <span class="keyword">break</span>;</div><div class="line">                     &#125;</div></pre></td></tr></table></figure>
<p>　　这里的主要难点是如何处理多个异步的添加玩家请求，经过思考和实验部分的解决了问题。</p>
<h4 id="b、多个客户端之间同步玩家的状态："><a href="#b、多个客户端之间同步玩家的状态：" class="headerlink" title="b、多个客户端之间同步玩家的状态："></a>b、多个客户端之间同步玩家的状态：</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">"updatemesh"</span>:</div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">var</span> dt=<span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">                        <span class="built_in">console</span>.log(dt.getTime()+<span class="string">"get updatemesh"</span>+arr[<span class="number">0</span>]);</div><div class="line">                        <span class="keyword">var</span> obj = arr_webplayers[arr[<span class="number">0</span>]];<span class="comment">//从网络玩家列表里找到这个玩家</span></div><div class="line">                        <span class="keyword">if</span>(obj)</div><div class="line">                        &#123;</div><div class="line">                            <span class="keyword">var</span> mesh = obj.mesh;</div><div class="line">                            mesh.position.x = <span class="built_in">parseFloat</span>(arr[<span class="number">2</span>]);<span class="comment">//这里已经产生了位移效果！！</span></div><div class="line">                            mesh.position.y = <span class="built_in">parseFloat</span>(arr[<span class="number">3</span>]);</div><div class="line">                            mesh.position.z = <span class="built_in">parseFloat</span>(arr[<span class="number">4</span>]);</div><div class="line">                            mesh.rotation.x = <span class="built_in">parseFloat</span>(arr[<span class="number">5</span>]);</div><div class="line">                            mesh.rotation.y = <span class="built_in">parseFloat</span>(arr[<span class="number">6</span>]);</div><div class="line">                            mesh.rotation.z = <span class="built_in">parseFloat</span>(arr[<span class="number">7</span>]);</div><div class="line">                           </div><div class="line">                            obj.vmove.x=<span class="built_in">parseFloat</span>(arr[<span class="number">8</span>]);</div><div class="line">                            obj.vmove.y=<span class="built_in">parseFloat</span>(arr[<span class="number">9</span>]);</div><div class="line">                            obj.vmove.z=<span class="built_in">parseFloat</span>(arr[<span class="number">10</span>]);</div><div class="line">                           </div><div class="line">                            obj.rychange= <span class="built_in">parseFloat</span>(arr[<span class="number">11</span>]);</div><div class="line">                            obj.countstop=<span class="number">0</span>;<span class="comment">//唤醒该物体的运动</span></div><div class="line">                            <span class="keyword">if</span>(obj.PlayAnnimation == <span class="literal">false</span>&amp;amp;&amp;amp;(obj.vmove.x != <span class="number">0</span> || obj.vmove.y != <span class="number">0</span> || obj.vmove.z != <span class="number">0</span> || obj.rychange != <span class="number">0</span>))</div><div class="line">                            &#123;</div><div class="line">                                obj.PlayAnnimation = <span class="literal">true</span>;</div><div class="line">                                obj.beginSP(<span class="number">0</span>);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div></pre></td></tr></table></figure>
<p>另一部分控制网络玩家的代码在<br>scene.registerBeforeRender（）中：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> key2 <span class="keyword">in</span> arr_webplayers)<span class="comment">//对于由其他客户端控制的物体</span></div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">var</span> obj = arr_webplayers[key2];</div><div class="line">                    <span class="keyword">switch</span>(obj.methodofmove)</div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">case</span> <span class="string">"controlwitha"</span>:</div><div class="line">                        &#123;</div><div class="line">                            obj.lab.rotation.y=(<span class="number">-1.55</span> - cameraArcRotative[<span class="number">0</span>].alpha)-obj.mesh.rotation.y;</div><div class="line">                            <span class="keyword">if</span>(obj.countstop&lt;=<span class="number">4</span>)</div><div class="line">                            &#123;</div><div class="line">                                <span class="keyword">if</span> ((obj.vmove.x != <span class="number">0</span> || obj.vmove.y != <span class="number">0</span> || obj.vmove.z != <span class="number">0</span> || obj.rychange != <span class="number">0</span>)&amp;amp;&amp;amp; obj.PlayAnnimation == <span class="literal">false</span>) &#123;</div><div class="line">                                    obj.PlayAnnimation = <span class="literal">true</span>;</div><div class="line">                                    obj.beginSP(<span class="number">0</span>);</div><div class="line">                                    obj.mesh.moveWithCollisions(obj.vmove);</div><div class="line">                                &#125;</div><div class="line">                                <span class="keyword">else</span> <span class="keyword">if</span> (obj.vmove.x == <span class="number">0</span> &amp;amp;&amp;amp; obj.vmove.y == <span class="number">0</span> &amp;amp;&amp;amp; obj.vmove.z == <span class="number">0</span> &amp;amp;&amp;amp; obj.rychange == <span class="number">0</span> &amp;amp;&amp;amp; obj.PlayAnnimation == <span class="literal">true</span>) &#123;</div><div class="line">                                    obj.countstop++;</div><div class="line">                                    <span class="keyword">if</span> (obj.countstop &gt; <span class="number">4</span>)<span class="comment">//连续4帧没有该对象的运动信息传过来，则该物体的运动计算进入休眠</span></div><div class="line">                                    &#123;</div><div class="line">                                        obj.PlayAnnimation = <span class="literal">false</span>;</div><div class="line">                                        obj.stopSP(<span class="number">0</span>);</div><div class="line">                                    &#125;</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">default</span> :</div><div class="line">                        &#123;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div></pre></td></tr></table></figure></p>
<h4 id="c、最后是对NPC物体运动同步的处理："><a href="#c、最后是对NPC物体运动同步的处理：" class="headerlink" title="c、最后是对NPC物体运动同步的处理："></a>c、最后是对NPC物体运动同步的处理：</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">"[admins]"</span>:</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span>(username==<span class="string">"admin"</span>)</div><div class="line">                &#123;<span class="comment">//adminserver不处理admin广播</span></div><div class="line"></div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">if</span>(!scene.isReady() || !arr_myplayers)</div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">return</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">var</span> arr_rabbitmove=<span class="built_in">JSON</span>.parse(str_data.substr(<span class="number">8</span>));</div><div class="line">                    <span class="keyword">var</span> len=arr_rabbitmove.length;</div><div class="line">                    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;len;i++)</div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">var</span> arr=arr_rabbitmove[i];</div><div class="line">                        <span class="keyword">var</span> rabbit=arr_animals[arr[<span class="number">0</span>]];</div><div class="line">                        <span class="keyword">var</span> rabbitmesh=rabbit.mesh;</div><div class="line">                        rabbitmesh.position=arr[<span class="number">1</span>];</div><div class="line">                        rabbitmesh.rotation=arr[<span class="number">2</span>];</div><div class="line">                        rabbit.vmove=arr[<span class="number">3</span>];</div><div class="line">                        rabbit.rychange=arr[<span class="number">4</span>];</div><div class="line"></div><div class="line">                        <span class="keyword">if</span>(arr[<span class="number">5</span>]==<span class="string">"run"</span>&amp;amp;&amp;amp;rabbit.state==<span class="string">"eat"</span>)</div><div class="line">                        &#123;</div><div class="line">                            rabbit.state=<span class="string">"run"</span>;</div><div class="line">                            rabbit.powerofmove=<span class="number">3</span>;</div><div class="line">                            scene.beginAnimation(rabbitmesh.skeleton, <span class="number">0</span>, <span class="number">72</span>, <span class="literal">true</span>, <span class="number">2.4</span>);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">else</span> <span class="keyword">if</span>(arr[<span class="number">5</span>]==<span class="string">"eat"</span>&amp;amp;&amp;amp;rabbit.state==<span class="string">"run"</span>)</div><div class="line">                        &#123;</div><div class="line">                            rabbit.state=<span class="string">"eat"</span>;</div><div class="line">                            rabbit.powerofmove=<span class="number">1</span>;</div><div class="line">                            scene.beginAnimation(rabbitmesh.skeleton, <span class="number">0</span>, <span class="number">72</span>, <span class="literal">true</span>, <span class="number">0.8</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div></pre></td></tr></table></figure>
<p>解开JSON，对每一个NPC物体分别处理。</p>
<h2 id="五、部署和使用："><a href="#五、部署和使用：" class="headerlink" title="五、部署和使用："></a>五、部署和使用：</h2><p>程序完整代码在可以在<a href="https://github.com/ljzc002/WebGL2下载，我编写的代码基于MIT协议发布，使用的第三方库文件按其原有的发布协议发布。" target="_blank" rel="external">https://github.com/ljzc002/WebGL2下载，我编写的代码基于MIT协议发布，使用的第三方库文件按其原有的发布协议发布。</a><br>部署：把PRACTICE/WebRoot/下的所有文件复制到PRACTICE3/目录下，将PRACTICE3/复制到Tomcat的WebApps/目录下，把PRACTICE3/改名为PRACTICE/，启动Tomcat，访问scene_link.html页面。<br>使用：第一个input输入Websocket所在IP，第二个input输入用户名（输入admin表示申请作为主机），点击“websocket连接”建立连接，点击“启动场景”启动WebGL场景。</p>
<h2 id="六、写在后面的话："><a href="#六、写在后面的话：" class="headerlink" title="六、写在后面的话："></a>六、写在后面的话：</h2><p>限于时间和编程水平，程序中还有很多bug和缺陷，欢迎大家批评指正。<br>音乐、美术、文学等常规的人类自我表达方式都要求人不断的在很短的时间片内对事物产生足够充分的认识，非有过人之天赋与辛苦之训练而不可成就；相对而言编程可以通过分解、封装、复用将空间复杂度转化为时间复杂度，任何普通人经过努力都能有所收获。</p>

    
  </div>
</article>

</div>


  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">打赏一下</span>
      <div class="donation-body">
        <div class="tip text-center">扫一扫，支持零壹博客</div>
        <ul class="theme.donation.items.length">
        
          <li class="item">
            <img src="/images/qr-wechat.jpg" alt="">
          </li>
        
          <li class="item">
            <img src="/images/qr-alipay.jpg" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>




  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              rel="noopener noreferrer"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              rel="noopener noreferrer"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/atom.xml"
              rel="noopener noreferrer"
              target="_blank"
              >
              RSS
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              rel="noopener noreferrer"
              target="_self"
              >
              搜索
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    
  <section class="duoshuo-comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="http://www.leonma.cn/2016/11/07/page71/index.html" data-title="结合WebSocket编写WebGL综合场景示例" data-url="http://www.leonma.cn/2016/11/07/page71/index.html"></div>
    <!-- 多说评论框 end -->
  </section>




  <script type="text/javascript">
  var duoshuoQuery = {short_name:"zerone01"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>


  </div>

  
  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
